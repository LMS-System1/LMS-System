<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LECTOR DBU-004 - LMS</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="runtime.data.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --cb-bg: #F5D0CE; --cb-texto: #721c24;
            --mp-color: #0ea5e9; --mp-bg: #f0f9ff; --match-bg: #dcfce7; --match-text: #166534;
            --no-match: #ffedd5; --no-match-text: #9a3412; --comi-mp: #fef9c3; --comi-mp-text: #854d0e;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); }
        
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 350px; }
        .login-box h2 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }
        .login-box input { display: block; width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); border: none; color: white; cursor: pointer; border-radius: 0.5rem; font-weight: 600; transition: 0.3s; }
        
        .container { max-width: 1450px; margin: 2rem auto; padding: 0 1.5rem; display: none; }

        /* NUEVO ESTILO PARA BIENVENIDA GRANDE */
        .welcome-header { 
            background: white; 
            padding: 2rem; 
            border-radius: 1rem; 
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .welcome-header i { color: var(--accent); font-size: 2.5rem; }
        .welcome-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .welcome-header span { color: var(--accent); text-transform: capitalize; }
        .welcome-header p { margin: 5px 0 0 0; color: var(--neutro); font-size: 0.95rem; }

        .upload-card { background: var(--white); padding: 1.5rem 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .brand { display: flex; gap: 12px; align-items: center; }
        .btn-cargar { background: var(--accent); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; }
        .btn-cargar.secondary { background: var(--neutro); }
        #upload { display: none; }

        #historial-area { display: none; margin-bottom: 2rem; animation: fadeIn 0.5s ease; }
        .historial-card { background: white; border-radius: 1rem; border: 2px solid var(--neutro); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .historial-header { background: var(--neutro); color: white; padding: 0.75rem 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .historial-table { width: 100%; border-collapse: collapse; }
        .historial-table th { background: #f8fafc; color: var(--neutro); font-size: 0.75rem; text-transform: uppercase; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border); text-align: left; letter-spacing: 0.05em; }
        .historial-table td { padding: 1rem 1.5rem; font-size: 1rem; font-weight: 600; color: var(--primary); }

        #reporte-area { display: none; animation: fadeIn 0.5s ease; }
        .summary-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .info-card { background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .saldo-val { display: block; font-size: 2rem; font-weight: 800; }
        .estado-tag { display: inline-flex; align-items: center; padding: 0.25rem 1rem; border-radius: 2rem; color: white; font-size: 0.85rem; font-weight: 700; }

        .table-container { background: white; border-radius: 1rem; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f5f9; color: var(--neutro); padding: 1rem; text-align: left; white-space: nowrap; }
        td { padding: 0.85rem 1rem; border-bottom: 1px solid #f1f5f9; }
        
        .celda-match { background-color: var(--match-bg) !important; color: var(--match-text) !important; }
        .celda-sin-match { background-color: var(--no-match) !important; color: var(--no-match-text) !important; }
        .celda-comi-mp { background-color: var(--comi-mp) !important; color: var(--comi-mp-text) !important; }
        .celda-descripcion-mp { background-color: var(--mp-bg) !important; color: var(--mp-color) !important; border-left: 4px solid var(--mp-color); }
        .col-especial { background-color: #f8fafc; font-weight: 700; color: var(--mp-color); border-left: 1px solid var(--border); text-align: right; }
        .col-fd-total { font-weight: 800; text-align: right; border-left: 1px solid var(--border); color: var(--neutro); }
        .bg-total-fd { background-color: var(--bordo-claro) !important; color: var(--bordo-texto) !important; }
        .celda-first-data { background-color: var(--bordo-claro) !important; color: var(--bordo-texto) !important; }
        .celda-cb { background-color: var(--cb-bg) !important; color: var(--cb-texto) !important; }

        #calc-container {
            position: fixed; bottom: 80px; right: 25px; width: 220px;
            background: #1e293b; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 10000; padding: 12px; cursor: move; display: none; border: 1px solid #334155;
        }
        #calc-header { color: white; font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        #close-calc { cursor: pointer; color: #94a3b8; font-size: 1.2rem; }
        #close-calc:hover { color: #ef4444; }
        #calc-display { 
            width: 100%; border: none; background: #0f172a; color: #10b981; 
            padding: 12px; text-align: right; font-family: 'Courier New', monospace; font-size: 1.3rem;
            border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; outline: none;
        }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-buttons button { 
            padding: 10px 2px; border: none; border-radius: 6px; background: #334155; 
            color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: 0.2s;
        }
        .calc-buttons button:hover { background: #475569; }
        .calc-buttons button:active { transform: scale(0.95); }
        .btn-op { background: #3b82f6 !important; }
        .btn-eq { background: #10b981 !important; grid-row: span 2; }
        
        #open-calc-btn {
            position: fixed; bottom: 20px; right: 25px; width: 50px; height: 50px;
            border-radius: 50%; background: var(--accent); color: white; border: none;
            cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); z-index: 9999;
            display: none; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s;
        }
        #open-calc-btn:hover { transform: scale(1.1); background: #2563eb; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <i class="fas fa-user-shield fa-3x" style="color: var(--accent); margin-bottom: 1rem;"></i>
        <h2>Sistema LMS</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contraseña">
        <button id="btnLogin">Ingresar al Sistema</button>
    </div>
</div>

<div class="container" id="main-content">
    
    <div class="welcome-header">
        <i class="fas fa-user-circle"></i>
        <div>
            <h1>Bienvenido, <span id="user-display"></span></h1>
            <p>Sistema de Gestión Lector DBU-004 LMS</p>
        </div>
    </div>

    <div class="upload-card">
        <div class="brand">
            <button class="btn-cargar" onclick="abrirSelector(false)">
                <i class="fas fa-credit-card"></i> Lector DBU-004
            </button>
            <button class="btn-cargar secondary" onclick="abrirSelector(true)">
                <i class="fas fa-history"></i> Ult. vez en "0"
            </button>
            <input type="file" id="upload" accept=".xlsx, .xls" />
        </div>
        <button id="downloadPdf" class="btn-pdf" style="background: #dc2626; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px;">
            <i class="fas fa-file-pdf"></i> Exportar a PDF
        </button>
    </div>

    <div id="historial-area">
        <div class="historial-card">
            <div class="historial-header">
                <i class="fas fa-search-dollar"></i> Resultado de búsqueda: Último balance en $0,00
            </div>
            <table class="historial-table">
                <thead>
                    <tr><th>BANCO / INFO</th><th>LIDER</th><th>UNIDAD</th><th>FECHA</th></tr>
                </thead>
                <tbody id="historialBody">
                    <tr><td id="h-colC">-</td><td id="h-colD">-</td><td id="h-colB">-</td><td id="h-colE">-</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="reporte-area">
        <div class="summary-grid">
            <div class="info-card">
                <div style="display: flex; gap: 3rem;">
                    <div class="info-group"><h4>Unidad</h4><p id="unidadNombre">-</p></div>
                    <div class="info-group"><h4>Líder de Cuenta</h4><p id="liderNombre">-</p></div>
                </div>
            </div>
            <div class="info-card" style="border-top: 4px solid var(--accent);">
                <div class="saldo-display" style="width: 100%;">
                    <h4>Balance Final</h4>
                    <span id="saldoFinal" class="saldo-val">$0,00</span>
                    <div id="estadoTexto" class="estado-tag">Cargando...</div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table><thead><tr id="tableHeader"></tr></thead><tbody id="tableBody"></tbody></table>
        </div>
    </div>
</div>

<div id="calc-container">
    <div id="calc-header"><span><i class="fas fa-calculator"></i> CALCULADORA</span><span id="close-calc">×</span></div>
    <input type="text" id="calc-display" readonly placeholder="0">
    <div class="calc-buttons">
        <button onclick="calcClear()" style="color: #ef4444;">C</button>
        <button class="btn-op" onclick="calcInput('/')">/</button><button class="btn-op" onclick="calcInput('*')">*</button><button onclick="calcBackspace()"><i class="fas fa-backspace"></i></button>
        <button onclick="calcInput('7')">7</button><button onclick="calcInput('8')">8</button><button onclick="calcInput('9')">9</button><button class="btn-op" onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button><button onclick="calcInput('5')">5</button><button onclick="calcInput('6')">6</button><button class="btn-op" onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button><button onclick="calcInput('2')">2</button><button onclick="calcInput('3')">3</button><button class="btn-eq" onclick="calcResult()">=</button>
        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button><button onclick="calcInput('.')">.</button>
    </div>
</div>

<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<script>
    let modoBusquedaCero = false;

    async function generarHash(string) {
        const msgUint8 = new TextEncoder().encode(string);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function validarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const hashIngresado = await generarHash(p);

        if (typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === hashIngresado) {
            document.getElementById('user-display').innerText = u;
            document.getElementById('login-overlay').remove();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else { alert("Credenciales incorrectas."); }
    }

    document.getElementById('btnLogin').addEventListener('click', validarLogin);
    document.getElementById('pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') validarLogin(); });

    // --- Lógica de archivos y negocio (abreviada para ahorrar espacio, pero igual a la anterior) ---
    function abrirSelector(esModoBusqueda) { modoBusquedaCero = esModoBusqueda; document.getElementById('upload').click(); }
    function limpiarMonto(valor) { if (valor === undefined || valor === null || valor === "") return null; if (typeof valor === 'number') return valor; let s = valor.toString().trim(); if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.'); else if (s.includes(',')) s = s.replace(',', '.'); let num = parseFloat(s.replace(/[^0-9.-]/g, '')); return isNaN(num) ? null : num; }
    function excelDateToJS(serial) { if (typeof serial === 'number') return new Date(Math.round((serial - 25569) * 86400 * 1000)); let d = new Date(serial); return isNaN(d.getTime()) ? new Date(0) : d; }

    document.getElementById('upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: "A", defval: ""});
            if(rows.length > 0) { if (modoBusquedaCero) { procesarUltimoCero(rows); } else { generarReporte(rows); } }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    function procesarUltimoCero(rows) {
        let encontrado = false;
        document.getElementById('reporte-area').style.display = 'none';
        document.getElementById('downloadPdf').style.display = 'none';
        for (let i = rows.length - 1; i >= 1; i--) {
            const valorL = limpiarMonto(rows[i].L);
            if (valorL === 0 && rows[i].L !== "") {
                document.getElementById('h-colC').innerText = rows[i].C || "N/A";
                document.getElementById('h-colD').innerText = rows[i].D || "N/A";
                document.getElementById('h-colB').innerText = rows[i].B || "N/A";
                document.getElementById('h-colE').innerText = rows[i].E || "N/A";
                document.getElementById('historial-area').style.display = 'block';
                encontrado = true; break;
            }
        }
        if (!encontrado) { alert("No se encontró ningún valor '0' en la columna L."); document.getElementById('historial-area').style.display = 'none'; }
    }

    function generarReporte(rows) {
        document.getElementById('historial-area').style.display = 'none';
        document.getElementById('reporte-area').style.display = 'block';
        document.getElementById('unidadNombre').innerText = rows[1]?.B || "Desconocida";
        let liderEncontrado = "No encontrado";
        for (let i = 0; i < rows.length; i++) { if (rows[i].C && rows[i].C.toString().toUpperCase().includes("HSBC")) { liderEncontrado = rows[i].D || "Sin nombre"; break; } }
        document.getElementById('liderNombre').innerText = liderEncontrado;
        const saldoNumerico = limpiarMonto(rows[rows.length - 1]?.L) || 0;
        const estadoTag = document.getElementById('estadoTexto');
        document.getElementById('saldoFinal').innerText = "$" + saldoNumerico.toLocaleString('es-AR', {minimumFractionDigits: 2});
        estadoTag.style.backgroundColor = saldoNumerico < 0 ? 'var(--negativo)' : (saldoNumerico > 0 ? 'var(--positivo)' : 'var(--neutro)');
        estadoTag.innerText = saldoNumerico < 0 ? "SOBRE REPORTADO" : (saldoNumerico > 0 ? "FALTA REPORTAR" : "CONSOLIDADO");

        let conciliadosJ = new Set(), conciliadosK = new Set();
        for (let i = 1; i < rows.length; i++) {
            let mK = limpiarMonto(rows[i].K) || 0;
            if (mK === 0) continue;
            let fE = excelDateToJS(rows[i].E);
            for (let j = 1; j < rows.length; j++) {
                if (conciliadosJ.has(j)) continue;
                if (mK === (limpiarMonto(rows[j].J) || 0) && Math.abs(fE - excelDateToJS(rows[j].E)) / 86400000 <= 10) {
                    conciliadosK.add(i); conciliadosJ.add(j); break;
                }
            }
        }

        const totalesFD = {};
        rows.forEach(fila => {
            const desc = (fila.I || "").toString().toUpperCase();
            if (desc.includes("FIRST DATA CONO SUR S")) {
                const fecha = fila.E ? fila.E.toString() : "Sin Fecha";
                totalesFD[fecha] = (totalesFD[fecha] || 0) + (limpiarMonto(fila.J) || 0);
            }
        });

        const colsVista = ['E', 'F', 'G', 'H', 'I', 'J', 'K'];
        const headerRow = document.getElementById('tableHeader');
        headerRow.innerHTML = '';
        colsVista.forEach(c => { const th = document.createElement('th'); th.innerText = rows[0][c] || c; headerRow.appendChild(th); });
        headerRow.innerHTML += '<th>Neto</th><th>Comisión MP</th><th>TOTAL FIRST DATA</th>';

        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        for (let i = 1; i < rows.length; i++) {
            const fila = rows[i];
            if (!fila.E && !fila.I) continue;
            const tr = document.createElement('tr');
            const descI = (fila.I || "").toString().toUpperCase();
            const fechaActual = fila.E ? fila.E.toString() : "Sin Fecha";
            const esMP_Calculo = (fila.H || "").toString().startsWith("***") && descI.startsWith("MERPAGO");
            const esComiMP = descI.includes("COMI MP");
            const esFirstData = descI.includes("FIRST DATA CONO SUR S");
            const esCB = descI.includes("CB");

            colsVista.forEach(c => {
                const td = document.createElement('td');
                td.innerText = fila[c] || '';
                let monto = limpiarMonto(fila[c]) || 0;
                if (c === 'I') {
                    if (esComiMP) td.classList.add('celda-comi-mp');
                    else if (esMP_Calculo) td.classList.add('celda-descripcion-mp');
                    else if (esFirstData) td.classList.add('celda-first-data');
                    else if (esCB) td.classList.add('celda-cb');
                } 
                else if (c === 'J') {
                    if (esCB) td.classList.add('celda-cb');
                    else if (esFirstData) td.classList.add('celda-first-data');
                    else if (monto !== 0) td.classList.add(conciliadosJ.has(i) ? 'celda-match' : 'celda-sin-match');
                } 
                else if (c === 'K') {
                    if (esComiMP) td.classList.add('celda-comi-mp');
                    else if (esCB) td.classList.add('celda-cb');
                    else if (monto !== 0) td.classList.add(conciliadosK.has(i) ? 'celda-match' : 'celda-sin-match');
                }
                tr.appendChild(td);
            });

            let cNeto = "-", cCom = "-";
            if (esMP_Calculo) {
                const valJ = Math.abs(limpiarMonto(fila.J) || 0);
                if (valJ > 0) {
                    cCom = (valJ / 1.0699).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    cNeto = (valJ - (valJ / 1.0699)).toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
            }

            let cTotalFD = "-";
            let tieneTotal = false;
            if (esFirstData) {
                let esUltimaFilaDelGrupo = true;
                for (let next = i + 1; next < rows.length; next++) {
                    const nextDesc = (rows[next].I || "").toString().toUpperCase();
                    if (nextDesc.includes("FIRST DATA CONO SUR S")) { if ((rows[next].E ? rows[next].E.toString() : "Sin Fecha") === fechaActual) { esUltimaFilaDelGrupo = false; } break; }
                }
                if (esUltimaFilaDelGrupo) { cTotalFD = totalesFD[fechaActual].toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}); tieneTotal = true; }
            }
            tr.innerHTML += `<td class="col-especial">${cNeto}</td><td class="col-especial">${cCom}</td><td class="col-fd-total ${tieneTotal ? 'bg-total-fd' : ''}">${cTotalFD}</td>`;
            tableBody.appendChild(tr);
        }
        document.getElementById('downloadPdf').style.display = 'flex';
    }

    document.getElementById('downloadPdf').addEventListener('click', function() {
        html2pdf().set({ margin: 5, filename: 'Reporte_DBU004.pdf', html2canvas: { scale: 3 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }).from(document.getElementById('reporte-area')).save();
    });

    function toggleCalc() { const calc = document.getElementById('calc-container'); calc.style.display = (calc.style.display === 'none' || calc.style.display === '') ? 'block' : 'none'; }
    document.getElementById('close-calc').onclick = toggleCalc;
    let calcDisp = document.getElementById('calc-display');
    function calcInput(v) { calcDisp.value += v; }
    function calcClear() { calcDisp.value = ''; }
    function calcBackspace() { calcDisp.value = calcDisp.value.slice(0, -1); }
    function calcResult() { try { let res = eval(calcDisp.value); calcDisp.value = Number.isInteger(res) ? res : res.toFixed(2); } catch(e) { calcDisp.value = "Error"; setTimeout(calcClear, 1000); } }

    dragElement(document.getElementById("calc-container"));
    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        document.getElementById("calc-header").onmousedown = dragMouseDown;
        function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
        function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; elmnt.style.bottom = "auto"; }
        function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
    }
</script>
</body>
</html>

