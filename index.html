<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LECTOR DBU-004 - LMS</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="runtime.data.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --cb-bg: #F5D0CE; --cb-texto: #721c24;
            --mp-color: #0ea5e9; --mp-bg: #f0f9ff; --match-bg: #dcfce7; --match-text: #166534;
            --no-match: #ffedd5; --no-match-text: #9a3412; --comi-mp: #fef9c3; --comi-mp-text: #854d0e;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); }
        
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 350px; }
        .login-box h2 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }
        .login-box input { display: block; width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); border: none; color: white; cursor: pointer; border-radius: 0.5rem; font-weight: 600; transition: 0.3s; }
        
        .container { max-width: 1450px; margin: 2rem auto; padding: 0 1.5rem; display: none; }

        .upload-card { background: var(--white); padding: 1.5rem 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        
        /* TOGGLE BUTTON STYLE */
        .toggle-container { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 8px 15px; border-radius: 50px; border: 1px solid var(--border); cursor: pointer; transition: 0.3s; user-select: none; }
        .toggle-switch { width: 40px; height: 20px; background: #cbd5e1; border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-container.on .toggle-switch { background: var(--positivo); }
        .toggle-container.on .toggle-switch::after { left: 22px; }

        .table-container { 
            background: white; border-radius: 1rem; border: 1px solid var(--border); 
            overflow: auto; max-height: 70vh; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        th { 
            background: #f1f5f9; color: var(--neutro); padding: 1rem; text-align: left; 
            white-space: nowrap; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border);
        }
        td { padding: 0.85rem 1rem; border-bottom: 1px solid #f1f5f9; }

        /* --- CAPA DE COLORES MANUALES (Sobrescriben todo con !important) --- */
        .manual-verde { background-color: #dcfce7 !important; color: #166534 !important; font-weight: 700 !important; }
        .manual-naranja { background-color: #ffedd5 !important; color: #9a3412 !important; font-weight: 700 !important; }
        .manual-rojo { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: 700 !important; }

        /* Si el Toggle está OFF, ignoramos las clases manuales */
        .marcas-off .manual-verde, .marcas-off .manual-naranja, .marcas-off .manual-rojo {
            background-color: inherit !important; color: inherit !important; font-weight: inherit !important;
        }

        /* --- CLASES AUTOMÁTICAS DEL REPORTE --- */
        .celda-match { background-color: var(--match-bg); color: var(--match-text); }
        .celda-sin-match { background-color: var(--no-match); color: var(--no-match-text); }
        .celda-comi-mp { background-color: var(--comi-mp); color: var(--comi-mp-text); }
        .celda-descripcion-mp { background-color: var(--mp-bg); color: var(--mp-color); border-left: 4px solid var(--mp-color); }
        .bg-total-fd { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .col-especial { background-color: #f8fafc; font-weight: 700; color: var(--mp-color); border-left: 1px solid var(--border); text-align: right; }
        .col-fd-total { font-weight: 800; text-align: right; border-left: 1px solid var(--border); color: var(--neutro); }

        .celda-interactiva { cursor: pointer; user-select: none; }
        .celda-interactiva:hover { filter: contrast(1.1); outline: 2px solid var(--accent); outline-offset: -2px; }

        /* CALCULADORA */
        #calc-container { position: fixed; bottom: 80px; right: 25px; width: 220px; background: #1e293b; border-radius: 10px; z-index: 10000; padding: 12px; cursor: move; display: none; border: 1px solid #334155; }
        #calc-header { color: white; font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #calc-display { width: 100%; border: none; background: #0f172a; color: #10b981; padding: 12px; text-align: right; font-family: monospace; font-size: 1.3rem; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-buttons button { padding: 10px 2px; border: none; border-radius: 6px; background: #334155; color: white; cursor: pointer; }
        #open-calc-btn { position: fixed; bottom: 20px; right: 25px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; border: none; cursor: pointer; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>Sistema LMS</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contraseña">
        <button id="btnLogin">Ingresar</button>
    </div>
</div>

<div class="container" id="main-content">
    <div class="upload-card">
        <div style="display: flex; gap: 10px;">
            <button class="btn-cargar" onclick="abrirSelector(false)"><i class="fas fa-file-excel"></i> Cargar DBU-004</button>
            <button class="btn-cargar secondary" onclick="abrirSelector(true)">Historial "0"</button>
            <input type="file" id="upload" style="display:none" accept=".xlsx, .xls" />
        </div>

        <div style="display: flex; gap: 15px; align-items: center;">
            <div id="toggleManual" class="toggle-container on" onclick="toggleCapas()">
                <div class="toggle-switch"></div>
                <span style="font-size: 0.75rem; font-weight: 800;">CAPA MANUAL</span>
            </div>
            <button id="downloadPdf" style="background: #dc2626; color: white; padding: 0.6rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; display: none;">PDF</button>
        </div>
    </div>

    <div id="reporte-area">
        <div id="sum-bar" style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="background:white; padding:15px; border-radius:10px; flex:1; border:1px solid var(--border)">
                <small style="color:var(--neutro)">Unidad:</small> <strong id="uNom">-</strong> | 
                <small style="color:var(--neutro)">Líder:</small> <strong id="lNom">-</strong>
            </div>
            <div style="background:white; padding:15px; border-radius:10px; border-left: 5px solid var(--accent); border:1px solid var(--border)">
                <small style="color:var(--neutro)">Balance:</small> <strong id="sFin">$0,00</strong> 
                <span id="eTxt" style="font-size:0.7rem; padding:3px 8px; border-radius:5px; margin-left:10px; color:white">-</span>
            </div>
        </div>
        
        <div class="table-container" id="tCont">
            <table>
                <thead><tr id="tHead"></tr></thead>
                <tbody id="tBody"></tbody>
            </table>
        </div>
    </div>

    <div id="hArea" style="display:none; margin-top:20px; background:white; border:1px solid var(--border); border-radius:10px; overflow:hidden">
        <div style="background:var(--primary); color:white; padding:10px; font-size:0.8rem">ÚLTIMO REGISTRO EN CERO</div>
        <table style="width:100%">
            <tbody id="hBody"></tbody>
        </table>
    </div>
</div>

<div id="calc-container">
    <div id="calc-header"><span>CALC</span><span onclick="toggleCalc()" style="cursor:pointer">×</span></div>
    <input type="text" id="calc-display" readonly>
    <div class="calc-buttons">
        <button onclick="calcClear()">C</button>
        <button onclick="calcInput('/')">/</button><button onclick="calcInput('*')">*</button><button onclick="calcBackspace()">←</button>
        <button onclick="calcInput('7')">7</button><button onclick="calcInput('8')">8</button><button onclick="calcInput('9')">9</button><button onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button><button onclick="calcInput('5')">5</button><button onclick="calcInput('6')">6</button><button onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button><button onclick="calcInput('2')">2</button><button onclick="calcInput('3')">3</button><button onclick="calcResult()" style="background:var(--positivo); grid-row:span 2">=</button>
        <button onclick="calcInput('0')" style="grid-column:span 2">0</button><button onclick="calcInput('.')">.</button>
    </div>
</div>
<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<script>
    let modoCero = false;
    let capasOn = true;

    function fmt(n) { return n?.toLocaleString('es-AR', { minimumFractionDigits: 2 }) || "-"; }
    function cln(v) { 
        if(!v) return null; if(typeof v==='number') return v;
        let s = v.toString().replace(/\./g, '').replace(',', '.');
        let n = parseFloat(s.replace(/[^0-9.-]/g, ''));
        return isNaN(n) ? null : n;
    }

    function rotar(e) {
        const td = e.currentTarget;
        const cls = ['', 'manual-verde', 'manual-naranja', 'manual-rojo'];
        let cur = 0;
        cls.forEach((c, i) => { if(c && td.classList.contains(c)) cur = i; });
        cls.forEach(c => { if(c) td.classList.remove(c); });
        let nxt = (cur + 1) % cls.length;
        if(cls[nxt]) td.classList.add(cls[nxt]);
    }

    function toggleCapas() {
        capasOn = !capasOn;
        document.getElementById('toggleManual').className = capasOn ? 'toggle-container on' : 'toggle-container';
        document.getElementById('tCont').className = capasOn ? 'table-container' : 'table-container marcas-off';
    }

    async function login() {
        const u = document.getElementById('user').value, p = document.getElementById('pass').value;
        const hB = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p));
        const hS = Array.from(new Uint8Array(hB)).map(b => b.toString(16).padStart(2, '0')).join('');
        if(typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === hS) {
            document.getElementById('login-overlay').remove();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else alert("Error");
    }
    document.getElementById('btnLogin').onclick = login;

    function abrirSelector(c) { modoCero = c; document.getElementById('upload').click(); }

    document.getElementById('upload').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (evt) => {
            const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array', cellDates: true});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: "A", defval: ""});
            if(modoCero) {
                for(let i=data.length-1; i>=1; i--) {
                    if(cln(data[i].L)===0) {
                        document.getElementById('hBody').innerHTML = `<tr><td>${data[i].B}</td><td>${data[i].D}</td><td>${data[i].E}</td></tr>`;
                        document.getElementById('hArea').style.display = 'block'; break;
                    }
                }
            } else rep(data);
            e.target.value = '';
        };
        r.readAsArrayBuffer(f);
    };

    function rep(rows) {
        document.getElementById('uNom').innerText = rows[1]?.B;
        let ldr = "-"; for(let r of rows) { if(r.C?.includes("HSBC")) { ldr = r.D; break; } }
        document.getElementById('lNom').innerText = ldr;
        const sld = cln(rows[rows.length-1]?.L) || 0;
        document.getElementById('sFin').innerText = fmt(sld);
        const et = document.getElementById('eTxt');
        et.innerText = sld < 0 ? "SOBRE" : (sld > 0 ? "FALTA" : "OK");
        et.style.background = sld < 0 ? 'var(--negativo)' : (sld > 0 ? 'var(--positivo)' : 'var(--neutro)');

        const h = document.getElementById('tHead'), b = document.getElementById('tBody');
        h.innerHTML = ''; b.innerHTML = '';
        const cs = ['E','F','G','H','I','J','K'];
        cs.forEach(c => h.innerHTML += `<th>${rows[0][c]||c}</th>`);
        h.innerHTML += '<th>Neto</th><th>Comi</th><th>Total FD</th>';

        // Lógica de Match automático
        let mJ = new Set(), mK = new Set();
        for(let i=1; i<rows.length; i++){
            let vk = cln(rows[i].K); if(!vk) continue;
            for(let j=1; j<rows.length; j++){
                if(!mJ.has(j) && vk === cln(rows[j].J)) { mJ.add(j); mK.add(i); break; }
            }
        }

        const fds = {};
        rows.forEach(r => { if(r.I?.includes("FIRST DATA")) { let f=r.E?.toString(); fds[f]=(fds[f]||0)+cln(r.J); } });

        rows.slice(1).forEach((r, idx) => {
            const i = idx + 1; if(!r.E && !r.I) return;
            const tr = document.createElement('tr');
            const dsc = r.I?.toString().toUpperCase() || "";
            const isMP = r.H?.toString().startsWith("***") && dsc.includes("MERPAGO");

            cs.forEach(c => {
                const td = document.createElement('td');
                const v = r[c], m = cln(v);
                td.innerText = (c==='J'||c==='K') ? fmt(m) : v;
                if(c==='I' && isMP) td.className = 'celda-descripcion-mp';
                if(c==='J' && mJ.has(i)) td.className = 'celda-match';
                if(c==='J' && m && !mJ.has(i)) td.className = 'celda-sin-match';
                if(c==='K' && mK.has(i)) td.className = 'celda-match';
                if(m !== null) { td.classList.add('celda-interactiva'); td.onclick = rotar; }
                tr.appendChild(td);
            });

            let n="-", c="-", f="-";
            if(isMP) { let j = Math.abs(cln(r.J)||0); c = fmt(j/6.099); n = fmt(j-(j/6.099)); }
            if(dsc.includes("FIRST DATA")) {
                let sig = rows[i+1];
                if(!sig || sig.E?.toString() !== r.E?.toString() || !sig.I?.includes("FIRST DATA")) f = fmt(fds[r.E?.toString()]);
            }
            
            [n,c,f].forEach((v, idxCalc) => {
                const td = document.createElement('td'); td.innerText = v;
                td.className = idxCalc < 2 ? "col-especial" : "col-fd-total";
                if(v!=="-") { td.classList.add('celda-interactiva'); td.onclick = rotar; }
                if(idxCalc === 2 && v !== "-") td.classList.add('bg-total-fd');
                tr.appendChild(td);
            });
            b.appendChild(tr);
        });
        document.getElementById('downloadPdf').style.display = 'block';
    }

    document.getElementById('downloadPdf').onclick = () => { html2pdf().from(document.getElementById('reporte-area')).save('Reporte.pdf'); };
    function toggleCalc() { let c = document.getElementById('calc-container'); c.style.display = c.style.display==='block' ? 'none' : 'block'; }
    let d = document.getElementById('calc-display');
    function calcInput(v) { d.value += v; }
    function calcClear() { d.value = ''; }
    function calcBackspace() { d.value = d.value.slice(0,-1); }
    function calcResult() { try { d.value = eval(d.value).toFixed(2); } catch { d.value = "Error"; } }

    const cl = document.getElementById("calc-container"), ch = document.getElementById("calc-header");
    let px=0, py=0, x=0, y=0;
    ch.onmousedown = (e) => {
        x=e.clientX; y=e.clientY;
        document.onmousemove = (e) => {
            px=x-e.clientX; py=y-e.clientY; x=e.clientX; y=e.clientY;
            cl.style.top = (cl.offsetTop - py) + "px"; cl.style.left = (cl.offsetLeft - px) + "px";
        };
        document.onmouseup = () => { document.onmousemove = null; };
    };
</script>
</body>
</html>
