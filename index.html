<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS System</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="runtime.data.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --cb-bg: #F5D0CE; --cb-texto: #721c24;
            --mp-color: #0ea5e9; --mp-bg: #f0f9ff; --match-bg: #dcfce7; --match-text: #166534;
            --no-match: #ffedd5; --no-match-text: #9a3412; --comi-mp: #fef9c3; --comi-mp-text: #854d0e;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); }
        
        @media print {
            .no-print, #calc-container, #open-calc-btn, .upload-card, .welcome-header { display: none !important; }
            .table-container { max-height: none !important; overflow: visible !important; border: none !important; }
            table { width: 100% !important; table-layout: auto !important; }
            th { position: static !important; background-color: #f1f5f9 !important; color: black !important; -webkit-print-color-adjust: exact; }
            .container { margin: 0 !important; padding: 0 !important; max-width: none !important; }
            .info-card { break-inside: avoid; border: 1px solid #eee !important; }
        }

        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 350px; }
        .login-box h2 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }
        .login-box input { display: block; width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); border: none; color: white; cursor: pointer; border-radius: 0.5rem; font-weight: 600; transition: 0.3s; }
        
        .container { max-width: 1450px; margin: 1rem auto; padding: 0 1.5rem; display: none; }

        .welcome-header { 
            background: white; padding: 1.2rem; border-radius: 1rem; border: 1px solid var(--border);
            margin-bottom: 1rem; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .welcome-header i { color: var(--accent); font-size: 2rem; }
        .welcome-header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .welcome-header p { margin: 2px 0 0 0; color: var(--neutro); font-size: 0.85rem; }

        .upload-card { background: var(--white); padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); gap: 10px; flex-wrap: wrap; }
        .brand { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .btn-cargar { background: var(--accent); color: white; padding: 0.6rem 1.2rem; border-radius: 0.75rem; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        
        #upload { display: none; }
        #lector-tools { display: none; gap: 12px; align-items: center; }

        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .info-card { background: white; padding: 0.8rem 1.2rem; border-radius: 0.75rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .info-card h4 { margin: 0; font-size: 0.85rem; color: var(--neutro); font-weight: 500; }
        .info-card span { font-weight: 700; font-size: 0.9rem; }
        .saldo-val { display: block; font-size: 1.4rem !important; font-weight: 800; }
        .estado-tag { display: inline-flex; align-items: center; padding: 0.2rem 0.8rem; border-radius: 2rem; color: white; font-size: 0.75rem; font-weight: 700; margin-top: 4px; }

        .table-container { background: white; border-radius: 1rem; border: 1px solid var(--border); overflow: auto; max-height: 75vh; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        th { background: #f1f5f9; color: var(--neutro); padding: 0.8rem; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); font-size: 0.8rem; }
        td { padding: 0.6rem 0.8rem; border-bottom: 1px solid #f1f5f9; }
        
        .manual-verde { background-color: #22c55e !important; color: white !important; }
        .manual-naranja { background-color: #f59e0b !important; color: white !important; }
        .manual-rojo { background-color: #ef4444 !important; color: white !important; }
        .celda-interactiva { cursor: pointer; user-select: none; transition: background 0.2s; }
        .celda-interactiva:hover { filter: brightness(0.9); }
        .celda-match { background-color: var(--match-bg); color: var(--match-text); }
        .celda-sin-match { background-color: var(--no-match); color: var(--no-match-text); }
        .celda-comi-mp { background-color: var(--comi-mp); color: var(--comi-mp-text); }
        .celda-descripcion-mp { background-color: var(--mp-bg); color: var(--mp-color); border-left: 4px solid var(--mp-color); }
        .bg-total-fd { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .celda-first-data { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .celda-cb { background-color: var(--cb-bg); color: var(--cb-texto); }
        .monto-rojo-cb { color: #ef4444 !important; background-color: #ffffff; font-weight: 700; }
        .btn-toggle-off { background: #10b981; }
        .btn-toggle-on { background: #f43f5e; }

        #calc-container { position: fixed; bottom: 80px; right: 25px; width: 220px; background: #1e293b; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 10000; padding: 12px; display: none; border: 1px solid #334155; }
        #calc-display { width: 100%; border: none; background: #0f172a; color: #10b981; padding: 12px; text-align: right; font-family: monospace; font-size: 1.3rem; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-buttons button { padding: 10px 2px; border: none; border-radius: 6px; background: #334155; color: white; cursor: pointer; font-weight: 600; }
        #open-calc-btn { position: fixed; bottom: 20px; right: 25px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; border: none; cursor: pointer; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <i class="fas fa-user-shield fa-3x" style="color: var(--accent); margin-bottom: 1rem;"></i>
        <h2>Sistema LMS</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contraseña">
        <button id="btnLogin">Ingresar al Sistema</button>
    </div>
</div>

<div class="container" id="main-content">
    <div class="welcome-header no-print">
        <i class="fas fa-user-circle"></i>
        <div>
            <h1>Bienvenido, <span id="user-display"></span></h1>
            <p>Sistema de Gestión Lector DBU-004 LMS</p>
        </div>
    </div>

    <div class="upload-card no-print">
        <div class="brand">
            <button class="btn-cargar" onclick="abrirSelector(false)">
                <i class="fas fa-file-excel"></i> Lector DBU-004
            </button>
            <button class="btn-cargar" style="background: var(--neutro);" onclick="abrirSelector(true)">
                <i class="fas fa-history"></i> Ult. vez en "0"
            </button>

            <div id="lector-tools">
                <button id="btnResetTotal" class="btn-cargar" style="background: #64748b;">
                    <i class="fas fa-trash-alt"></i> Limpiar mis marcas
                </button>
                <button id="btnToggleManual" class="btn-cargar btn-toggle-off">
                    <i class="fas fa-lock-open"></i> Coloreo: OFF
                </button>
            </div>

            <input type="file" id="upload" accept=".xlsx, .xls" />
        </div>
        
        <button id="downloadPdf" class="btn-cargar" style="background: #dc2626; display: none;">
            <i class="fas fa-file-pdf"></i> Exportar a PDF
        </button>
    </div>

    <div id="search-zero-area" style="display:none;">
        <div class="table-container" style="max-height: none; margin-bottom: 2rem;">
            <table class="search-table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f1f5f9; border-bottom:2px solid var(--border);">
                        <th style="padding:10px;">Banco</th>
                        <th style="padding:10px;">Tipo</th>
                        <th style="padding:10px;">Fecha</th>
                        <th style="padding:10px;">Estado</th>
                    </tr>
                </thead>
                <tbody id="search-zero-body"></tbody>
            </table>
        </div>
    </div>

    <div id="reporte-area" style="display:none;">
        <div class="summary-grid">
            <div class="info-card">
                <div>
                    <h4>Unidad: <span id="unidadNombre" style="color:var(--accent)">-</span></h4>
                    <h4 style="margin-top:5px;">Líder: <span id="liderNombre" style="color:var(--accent)">-</span></h4>
                </div>
            </div>
            <div class="info-card" style="border-right: 4px solid var(--accent);">
                <div>
                    <h4>Balance Final</h4>
                    <span id="saldoFinal" class="saldo-val">$0,00</span>
                </div>
                <div id="estadoTexto" class="estado-tag">Cargando...</div>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="calc-container">
    <div id="calc-header" style="color:white; display:flex; justify-content:space-between; padding:12px; cursor:move; font-size: 0.75rem; font-weight: 700;">
        <span><i class="fas fa-calculator"></i> CALCULADORA</span>
        <span id="close-calc" style="cursor:pointer; font-size: 1.2rem;">×</span>
    </div>
    <input type="text" id="calc-display" readonly placeholder="0">
    <div class="calc-buttons" style="padding: 0 12px 12px 12px;">
        <button onclick="calcClear()" style="color: #ef4444;">C</button>
        <button onclick="calcInput('/')">/</button>
        <button onclick="calcInput('*')">*</button>
        <button onclick="calcInput('7')">7</button>
        <button onclick="calcInput('8')">8</button>
        <button onclick="calcInput('9')">9</button>
        <button onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button>
        <button onclick="calcInput('5')">5</button>
        <button onclick="calcInput('6')">6</button>
        <button onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button>
        <button onclick="calcInput('2')">2</button>
        <button onclick="calcInput('3')">3</button>
        <button onclick="calcResult()" style="background:var(--positivo)">=</button>
        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button>
        <button onclick="calcInput('.')">.</button>
    </div>
</div>
<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<script>
    let modoBusquedaCero = false;
    let coloreoBloqueado = false;

    function formatMoney(val) {
        if (val === null || val === undefined || isNaN(val)) return "-";
        return val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function rotarColor(e) {
        if (coloreoBloqueado) return;
        const td = e.currentTarget;
        const estados = ['', 'manual-verde', 'manual-naranja', 'manual-rojo'];
        let actualIdx = 0;
        estados.forEach((cls, idx) => {
            if (cls !== '' && td.classList.contains(cls)) actualIdx = idx;
        });
        estados.forEach(cls => { if(cls !== '') td.classList.remove(cls); });
        let siguienteIdx = (actualIdx + 1) % estados.length;
        if (estados[siguienteIdx] !== '') td.classList.add(estados[siguienteIdx]);
    }

    document.getElementById('btnToggleManual').addEventListener('click', function() {
        coloreoBloqueado = !coloreoBloqueado;
        this.innerHTML = coloreoBloqueado ? '<i class="fas fa-lock"></i> Coloreo: ON' : '<i class="fas fa-lock-open"></i> Coloreo: OFF';
        this.className = coloreoBloqueado ? 'btn-cargar btn-toggle-on' : 'btn-cargar btn-toggle-off';
    });

    document.getElementById('btnResetTotal').addEventListener('click', function() {
        document.querySelectorAll('.manual-verde, .manual-naranja, .manual-rojo').forEach(el => {
            el.classList.remove('manual-verde', 'manual-naranja', 'manual-rojo');
        });
    });

    async function generarHash(string) {
        const msgUint8 = new TextEncoder().encode(string);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function validarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const hashIngresado = await generarHash(p);
        if (typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === hashIngresado) {
            document.getElementById('user-display').innerText = u;
            document.getElementById('login-overlay').remove();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else { alert("Credenciales incorrectas."); }
    }
    document.getElementById('btnLogin').onclick = validarLogin;

    function abrirSelector(esModoBusqueda) { 
        modoBusquedaCero = esModoBusqueda; 
        document.getElementById('upload').click(); 
    }
    
    function limpiarMonto(valor) { 
        if (valor === undefined || valor === null || valor === "") return null; 
        if (typeof valor === 'number') return valor; 
        let s = valor.toString().trim(); 
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.'); 
        else if (s.includes(',')) s = s.replace(',', '.'); 
        let num = parseFloat(s.replace(/[^0-9.-]/g, '')); 
        return isNaN(num) ? null : num; 
    }

    function excelDateToJS(serial) { 
        if (typeof serial === 'number') return new Date(Math.round((serial - 25569) * 86400 * 1000)); 
        let d = new Date(serial); return isNaN(d.getTime()) ? new Date(0) : d; 
    }

    document.getElementById('upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: "A", defval: ""});
            if(rows.length > 0) { 
                if (modoBusquedaCero) { 
                    procesarUltimoCero(rows); 
                } else { 
                    generarReporte(rows); 
                } 
            }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    function procesarUltimoCero(rows) {
        document.getElementById('lector-tools').style.display = 'none';
        let encontrado = false;
        const body = document.getElementById('search-zero-body');
        body.innerHTML = '';
        for (let i = rows.length - 1; i >= 1; i--) {
            if (limpiarMonto(rows[i].L) === 0 && rows[i].L !== "") {
                let tipoReal = rows[i].D || "N/A";
                let banco = rows[i].C || "N/A";
                let fecha = rows[i].E || "N/A";
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="padding:10px; border-bottom:1px solid #eee;">${banco}</td>
                    <td style="padding:10px; border-bottom:1px solid #eee; font-weight:600; color:var(--accent)">${tipoReal}</td>
                    <td style="padding:10px; border-bottom:1px solid #eee;">${fecha}</td>
                    <td style="padding:10px; border-bottom:1px solid #eee;"><span class="estado-tag" style="background:var(--positivo)">Último $0 encontrado</span></td>
                `;
                body.appendChild(tr);
                document.getElementById('search-zero-area').style.display = 'block';
                document.getElementById('reporte-area').style.display = 'none'; 
                encontrado = true; 
                break;
            }
        }
        if (!encontrado) alert("No se halló balance en 0.");
    }

    function generarReporte(rows) {
        document.getElementById('lector-tools').style.display = 'flex';
        document.getElementById('search-zero-area').style.display = 'none';
        document.getElementById('reporte-area').style.display = 'block';
        document.getElementById('unidadNombre').innerText = rows[1]?.B || "N/A";
        let lider = "N/A";
        for(let r of rows) { if(r.C && r.C.toString().includes("HSBC")) { lider = r.D; break; } }
        document.getElementById('liderNombre').innerText = lider;
        const saldo = limpiarMonto(rows[rows.length-1]?.L) || 0;
        document.getElementById('saldoFinal').innerText = "$" + formatMoney(saldo);
        const tag = document.getElementById('estadoTexto');
        tag.style.background = saldo < 0 ? 'var(--negativo)' : (saldo > 0 ? 'var(--positivo)' : 'var(--neutro)');
        tag.innerText = saldo < 0 ? "SOBRE REPORTADO" : (saldo > 0 ? "FALTA REPORTAR" : "CONSOLIDADO");
        
        let cJ = new Set(), cK = new Set();
        for(let i=1; i<rows.length; i++) {
            let mK = limpiarMonto(rows[i].K);
            if(!mK) continue;
            let fE = excelDateToJS(rows[i].E);
            for(let j=1; j<rows.length; j++){
                if(cJ.has(j)) continue;
                if(mK === limpiarMonto(rows[j].J) && Math.abs(fE - excelDateToJS(rows[j].E)) <= 864000000) {
                    cK.add(i); cJ.add(j); break;
                }
            }
        }
        
        const totalesFD = {};
        const bancosCB = new Set();
        rows.forEach(f => {
            const desc = (f.I || "").toString().toUpperCase();
            if (desc.includes(" - CB ")) {
                const partes = desc.split(" - CB ");
                if (partes.length > 1) bancosCB.add(partes[1].trim());
            }
        });
        rows.forEach(f => {
            const desc = (f.I || "").toString().toUpperCase();
            if (desc.includes("FIRST DATA") || Array.from(bancosCB).some(b => desc === b)) {
                let fe = f.E ? f.E.toString() : "SF";
                totalesFD[fe] = (totalesFD[fe]||0) + (limpiarMonto(f.J)||0);
            }
        });

        const cols = ['E','F','G','H','I','J','K'];
        const hRow = document.getElementById('tableHeader');
        hRow.innerHTML = '';
        cols.forEach(c => { let th=document.createElement('th'); th.innerText=rows[0][c]||c; hRow.appendChild(th); });
        hRow.innerHTML += '<th>Monto Neto</th><th>Comision MP</th><th>TOTAL FD</th>';
        
        const body = document.getElementById('tableBody');
        body.innerHTML = '';
        for(let i=1; i<rows.length; i++){
            const fila = rows[i];
            if(!fila.E && !fila.I) continue;
            const tr = document.createElement('tr');
            const desc = (fila.I || "").toString().toUpperCase();
            const esMP = (fila.H||"").toString().startsWith("***") && desc.startsWith("MERPAGO");
            const esFD = desc.includes("FIRST DATA");
            const esBancarioCB = Array.from(bancosCB).some(b => desc === b);
            
            cols.forEach(c => {
                const td = document.createElement('td');
                let monto = limpiarMonto(fila[c]);
                td.innerText = (c==='J'||c==='K') && monto !== null ? formatMoney(monto) : (fila[c]||'');
                if(c === 'I' || c === 'J' || c === 'K') { td.classList.add('celda-interactiva'); td.onclick = rotarColor; }
                if(c==='J' || c==='K') {
                    if(monto !== 0 && monto !== null) {
                        if(c==='J' && (esFD || esBancarioCB)) td.classList.add('celda-first-data');
                        else if (c==='K' && desc.includes(" - CB ")) td.classList.add('monto-rojo-cb');
                        else td.classList.add( (c==='J' ? cJ.has(i) : cK.has(i)) ? 'celda-match' : 'celda-sin-match' );
                    }
                }
                if(c==='I'){
                    if(desc.includes("COMI MP")) td.classList.add('celda-comi-mp');
                    if(esMP) td.classList.add('celda-descripcion-mp');
                    if(esFD || esBancarioCB) td.classList.add('celda-first-data');
                    if(desc.includes(" - CB ")) td.classList.add('celda-cb');
                }
                tr.appendChild(td);
            });
            
            let nVal = "-", cVal = "-", tVal = "-";
            if(esMP) {
                let v = Math.abs(limpiarMonto(fila.J)||0);
                if (v > 0) {
                    let fe = excelDateToJS(fila.E);
                    let div = 1.0699; 
                    if (fe >= new Date(2024, 2, 1) && fe <= new Date(2024, 8, 30)) div = 1.0899;
                    else if (fe > new Date(2024, 8, 30) && fe < new Date(2025, 1, 1)) div = 1.0799;
                    nVal = formatMoney(v / div); cVal = formatMoney(v - (v / div));
                }
            }
            if(esFD || esBancarioCB) {
                let fe = fila.E ? fila.E.toString() : "SF";
                if (fe !== (rows[i + 1]?.E?.toString() || null)) tVal = formatMoney(totalesFD[fe]);
            }
            [nVal, cVal, tVal].forEach((txt, idx) => {
                const td = document.createElement('td');
                td.innerText = txt;
                td.classList.add('celda-interactiva');
                td.onclick = rotarColor;
                if(txt !== "-") {
                    if(idx < 2) td.classList.add('celda-descripcion-mp');
                    else td.classList.add('bg-total-fd');
                }
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
        document.getElementById('downloadPdf').style.display = 'flex';
    }

    document.getElementById('downloadPdf').onclick = () => {
        const elemento = document.getElementById('reporte-area');
        const opt = {
            margin:       [10, 10, 10, 10], 
            filename:     'Reporte_LMS.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, logging: false, letterRendering: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };
        html2pdf().set(opt).from(elemento).save();
    };

    function toggleCalc() { const c = document.getElementById('calc-container'); c.style.display = (c.style.display==='none'||c.style.display==='')?'block':'none'; }
    function calcInput(v) { document.getElementById('calc-display').value += v; }
    function calcClear() { document.getElementById('calc-display').value = ''; }
    function calcResult() { try { let res = eval(document.getElementById('calc-display').value); document.getElementById('calc-display').value = Number.isInteger(res) ? res : res.toFixed(2); } catch(e) { document.getElementById('calc-display').value = "Error"; } }
    document.getElementById('close-calc').onclick = toggleCalc;

    const calc = document.getElementById("calc-container");
    const header = document.getElementById("calc-header");
    let px=0, py=0, cx=0, cy=0;
    header.onmousedown = (e) => {
        cx=e.clientX; cy=e.clientY;
        document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
        document.onmousemove = (e) => {
            px=cx-e.clientX; py=cy-e.clientY; cx=e.clientX; cy=e.clientY;
            calc.style.top = (calc.offsetTop - py) + "px"; calc.style.left = (calc.offsetLeft - px) + "px";
        };
    };
</script>
</body>
</html>
