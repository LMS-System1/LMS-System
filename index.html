<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA LMS - CONTROL DBU-004</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="usuarios.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --cb-bg: #F5D0CE; --cb-texto: #721c24;
            --mp-color: #0ea5e9; --mp-bg: #f0f9ff; --match-bg: #dcfce7; --match-text: #166534;
            --no-match: #ffedd5; --no-match-text: #9a3412; --comi-mp: #fef9c3; --comi-mp-text: #854d0e;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); overflow-x: hidden; }
        
        /* --- ESTILOS LOGIN PREMIUM --- */
        #login-overlay { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at top right, #1e293b, #0f172a); 
            z-index: 9999; display: flex; justify-content: center; align-items: center; 
        }
        .login-box { 
            background: rgba(255, 255, 255, 0.95); padding: 2.5rem; border-radius: 1.5rem; 
            text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); 
            width: 380px; border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
            animation: fadeIn 0.8s ease-out;
        }
        .login-box h2 { margin: 0.5rem 0 0.2rem 0; font-size: 1.6rem; color: var(--primary); }
        .login-box p { color: var(--neutro); font-size: 0.9rem; margin-bottom: 2rem; }
        .login-box input { 
            width: 100%; padding: 0.9rem 1rem; margin: 0.5rem 0; border: 1px solid var(--border); 
            border-radius: 0.75rem; box-sizing: border-box; background: #f1f5f9; transition: all 0.3s ease;
        }
        .login-box input:focus { outline: none; border-color: var(--accent); background: white; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }
        .login-box button { 
            width: 100%; padding: 1rem; margin-top: 1.5rem; background: var(--accent); border: none; 
            color: white; cursor: pointer; border-radius: 0.75rem; font-weight: 700; transition: 0.3s; 
        }
        .login-box button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container { max-width: 1450px; margin: 2rem auto; padding: 0 1.5rem; display: none; animation: fadeIn 0.5s ease; }

        /* --- BIENVENIDA GRANDE --- */
        .welcome-header { 
            background: white; padding: 2rem; border-radius: 1.5rem; border: 1px solid var(--border);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .welcome-header i { color: var(--accent); font-size: 3rem; }
        .welcome-header h1 { margin: 0; font-size: 1.8rem; font-weight: 800; }
        .welcome-header span { color: var(--accent); text-transform: capitalize; }
        .welcome-header p { margin: 5px 0 0 0; color: var(--neutro); font-size: 1rem; }

        /* --- TARJETA DE ACCIONES --- */
        .upload-card { 
            background: var(--white); padding: 1.5rem 2rem; border-radius: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 2rem; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); 
        }
        .brand { display: flex; gap: 12px; align-items: center; }
        .btn-cargar { 
            background: var(--accent); color: white; padding: 0.8rem 1.8rem; border-radius: 0.75rem; 
            border: none; cursor: pointer; font-size: 1rem; font-weight: 700; display: flex; 
            align-items: center; gap: 10px; transition: 0.3s; 
        }
        .btn-cargar:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-cargar.secondary { background: var(--neutro); }
        #upload { display: none; }

        /* --- REPORTES Y TABLAS --- */
        #historial-area, #reporte-area { display: none; margin-bottom: 2rem; }
        .summary-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .info-card { background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .saldo-val { display: block; font-size: 2.2rem; font-weight: 800; margin: 0.5rem 0; }
        .estado-tag { display: inline-flex; align-items: center; padding: 0.4rem 1.2rem; border-radius: 2rem; color: white; font-size: 0.85rem; font-weight: 800; text-transform: uppercase; }

        .table-container { background: white; border-radius: 1rem; border: 1px solid var(--border); overflow-x: auto; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f1f5f9; color: var(--neutro); padding: 1.2rem 1rem; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border); }
        td { padding: 0.9rem 1rem; border-bottom: 1px solid #f1f5f9; }

        /* --- CLASES DE CELDAS --- */
        .celda-match { background-color: var(--match-bg) !important; color: var(--match-text) !important; font-weight: 600; }
        .celda-sin-match { background-color: var(--no-match) !important; color: var(--no-match-text) !important; font-weight: 600; }
        .celda-comi-mp { background-color: var(--comi-mp) !important; color: var(--comi-mp-text) !important; }
        .celda-descripcion-mp { background-color: var(--mp-bg) !important; color: var(--mp-color) !important; border-left: 4px solid var(--mp-color); font-weight: 600; }
        .col-especial { background-color: #f8fafc; font-weight: 700; color: var(--mp-color); text-align: right; border-left: 1px solid var(--border); }
        .col-fd-total { font-weight: 800; text-align: right; border-left: 1px solid var(--border); }
        .bg-total-fd { background-color: var(--bordo-claro) !important; color: var(--bordo-texto) !important; }
        .celda-first-data { background-color: var(--bordo-claro) !important; color: var(--bordo-texto) !important; }
        .celda-cb { background-color: var(--cb-bg) !important; color: var(--cb-texto) !important; }

        /* --- CALCULADORA --- */
        #calc-container {
            position: fixed; bottom: 85px; right: 25px; width: 240px;
            background: #1e293b; border-radius: 12px; box-shadow: 0 20px 25px rgba(0,0,0,0.4);
            z-index: 10000; padding: 15px; cursor: move; display: none; border: 1px solid #334155;
        }
        #calc-header { color: white; font-size: 0.8rem; font-weight: 700; margin-bottom: 12px; display: flex; justify-content: space-between; }
        #calc-display { 
            width: 100%; border: none; background: #0f172a; color: #10b981; 
            padding: 15px; text-align: right; font-family: monospace; font-size: 1.5rem;
            border-radius: 8px; margin-bottom: 12px; box-sizing: border-box;
        }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .calc-buttons button { padding: 12px; border: none; border-radius: 8px; background: #334155; color: white; cursor: pointer; font-weight: 600; }
        .calc-buttons button:hover { background: #475569; }
        .btn-op { background: var(--accent) !important; }
        .btn-eq { background: var(--positivo) !important; grid-row: span 2; }

        #open-calc-btn {
            position: fixed; bottom: 20px; right: 25px; width: 55px; height: 55px;
            border-radius: 50%; background: var(--accent); color: white; border: none;
            cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); z-index: 9999;
            display: none; align-items: center; justify-content: center; font-size: 1.3rem; transition: 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <div style="background: var(--accent); width: 60px; height: 60px; border-radius: 1.2rem; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.2rem; box-shadow: 0 8px 16px rgba(59,130,246,0.3);">
            <i class="fas fa-file-invoice-dollar" style="color: white; font-size: 1.8rem;"></i>
        </div>
        <h2>LMS Finanzas</h2>
        <p>Control Interno DBU-004</p>
        
        <input type="text" id="user" placeholder="Nombre de usuario" spellcheck="false">
        <input type="password" id="pass" placeholder="Contraseña">
        
        <button id="btnLogin">Iniciar Sesión</button>
        
        <div style="margin-top: 1.8rem; font-size: 0.7rem; color: #94a3b8; letter-spacing: 0.5px;">
            <i class="fas fa-lock"></i> ACCESO RESTRINGIDO A PERSONAL AUTORIZADO
        </div>
    </div>
</div>

<div class="container" id="main-content">
    
    <div class="welcome-header">
        <i class="fas fa-user-circle"></i>
        <div>
            <h1>Bienvenido, <span id="user-display">Usuario</span></h1>
            <p><i class="far fa-calendar-alt"></i> Panel de Gestión DBU-004 LMS | Sesión Activa</p>
        </div>
    </div>

    <div class="upload-card">
        <div class="brand">
            <button class="btn-cargar" onclick="abrirSelector(false)">
                <i class="fas fa-plus-circle"></i> Nueva Conciliación DBU-004
            </button>
            <button class="btn-cargar secondary" onclick="abrirSelector(true)">
                <i class="fas fa-search"></i> Buscar Último en "0"
            </button>
            <input type="file" id="upload" accept=".xlsx, .xls" />
        </div>
        <button id="downloadPdf" style="background: #dc2626; color: white; padding: 0.7rem 1.4rem; border: none; border-radius: 0.75rem; cursor: pointer; font-weight: 700; display: none; align-items: center; gap: 8px; transition: 0.3s;">
            <i class="fas fa-file-pdf"></i> Descargar Informe PDF
        </button>
    </div>

    <div id="historial-area">
        <div style="background: white; border-radius: 1rem; border: 2px solid var(--neutro); overflow: hidden;">
            <div style="background: var(--neutro); color: white; padding: 1rem 1.5rem; font-weight: 700;">
                <i class="fas fa-info-circle"></i> Último Balance Cerrado ($0,00)
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 1rem;">BANCO / INFO</th>
                        <th>LIDER</th>
                        <th>UNIDAD</th>
                        <th>FECHA</th>
                    </tr>
                </thead>
                <tbody id="historialBody">
                    <tr style="font-size: 1.1rem; font-weight: 600;">
                        <td id="h-colC" style="padding: 1.2rem;">-</td>
                        <td id="h-colD">-</td>
                        <td id="h-colB">-</td>
                        <td id="h-colE">-</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="reporte-area">
        <div class="summary-grid">
            <div class="info-card">
                <div style="display: flex; gap: 4rem;">
                    <div><h4 style="margin: 0; color: var(--neutro); font-size: 0.8rem;">UNIDAD</h4><p id="unidadNombre" style="margin: 5px 0 0 0; font-weight: 700; font-size: 1.2rem;">-</p></div>
                    <div><h4 style="margin: 0; color: var(--neutro); font-size: 0.8rem;">LÍDER DE CUENTA</h4><p id="liderNombre" style="margin: 5px 0 0 0; font-weight: 700; font-size: 1.2rem;">-</p></div>
                </div>
            </div>
            <div class="info-card" style="border-top: 5px solid var(--accent); flex-direction: column; align-items: flex-start;">
                <h4 style="margin: 0; color: var(--neutro); font-size: 0.8rem;">BALANCE FINAL DE CARTERA</h4>
                <span id="saldoFinal" class="saldo-val">$0,00</span>
                <div id="estadoTexto" class="estado-tag">Cargando...</div>
            </div>
        </div>
        <div class="table-container">
            <table id="tablaPrincipal">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<div id="calc-container">
    <div id="calc-header"><span><i class="fas fa-calculator"></i> CALCULADORA</span><span id="close-calc" style="cursor:pointer">×</span></div>
    <input type="text" id="calc-display" readonly placeholder="0">
    <div class="calc-buttons">
        <button onclick="calcClear()" style="color: #ef4444;">C</button>
        <button class="btn-op" onclick="calcInput('/')">/</button><button class="btn-op" onclick="calcInput('*')">*</button><button onclick="calcBackspace()"><i class="fas fa-backspace"></i></button>
        <button onclick="calcInput('7')">7</button><button onclick="calcInput('8')">8</button><button onclick="calcInput('9')">9</button><button class="btn-op" onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button><button onclick="calcInput('5')">5</button><button onclick="calcInput('6')">6</button><button class="btn-op" onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button><button onclick="calcInput('2')">2</button><button onclick="calcInput('3')">3</button><button class="btn-eq" onclick="calcResult()">=</button>
        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button><button onclick="calcInput('.')">.</button>
    </div>
</div>

<script>
    let modoBusquedaCero = false;

    // --- SEGURIDAD ---
    async function generarHash(string) {
        const msgUint8 = new TextEncoder().encode(string);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function validarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const hashIngresado = await generarHash(p);

        if (typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === hashIngresado) {
            document.getElementById('user-display').innerText = u;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else { alert("Usuario o contraseña incorrectos."); }
    }

    document.getElementById('btnLogin').addEventListener('click', validarLogin);
    document.getElementById('pass').addEventListener('keypress', (e) => { if(e.key === 'Enter') validarLogin(); });

    // --- LÓGICA DE NEGOCIO ---
    function abrirSelector(esModoBusqueda) {
        modoBusquedaCero = esModoBusqueda;
        document.getElementById('upload').click();
    }

    function limpiarMonto(valor) {
        if (valor === undefined || valor === null || valor === "") return null;
        if (typeof valor === 'number') return valor;
        let s = valor.toString().trim();
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.');
        else if (s.includes(',')) s = s.replace(',', '.');
        let num = parseFloat(s.replace(/[^0-9.-]/g, ''));
        return isNaN(num) ? null : num;
    }

    function excelDateToJS(serial) {
        if (typeof serial === 'number') return new Date(Math.round((serial - 25569) * 86400 * 1000));
        let d = new Date(serial);
        return isNaN(d.getTime()) ? new Date(0) : d;
    }

    document.getElementById('upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, {type: 'array', cellDates: true});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: "A", defval: ""});
            if(rows.length > 0) {
                if (modoBusquedaCero) { procesarUltimoCero(rows); } 
                else { generarReporte(rows); }
            }
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    function procesarUltimoCero(rows) {
        let encontrado = false;
        document.getElementById('reporte-area').style.display = 'none';
        document.getElementById('downloadPdf').style.display = 'none';
        for (let i = rows.length - 1; i >= 1; i--) {
            const valorL = limpiarMonto(rows[i].L);
            if (valorL === 0 && rows[i].L !== "") {
                document.getElementById('h-colC').innerText = rows[i].C || "N/A";
                document.getElementById('h-colD').innerText = rows[i].D || "N/A";
                document.getElementById('h-colB').innerText = rows[i].B || "N/A";
                document.getElementById('h-colE').innerText = rows[i].E || "N/A";
                document.getElementById('historial-area').style.display = 'block';
                encontrado = true; break;
            }
        }
        if (!encontrado) alert("No se encontró ningún balance en '0' en el archivo.");
    }

    function generarReporte(rows) {
        document.getElementById('historial-area').style.display = 'none';
        document.getElementById('reporte-area').style.display = 'block';
        document.getElementById('unidadNombre').innerText = rows[1]?.B || "Desconocida";
        
        let lider = "No encontrado";
        for (let i = 0; i < rows.length; i++) {
            if (rows[i].C && rows[i].C.toString().toUpperCase().includes("HSBC")) {
                lider = rows[i].D || "Sin nombre"; break;
            }
        }
        document.getElementById('liderNombre').innerText = lider;

        const saldoFinal = limpiarMonto(rows[rows.length - 1]?.L) || 0;
        const saldoDisp = document.getElementById('saldoFinal');
        const estadoTag = document.getElementById('estadoTexto');
        
        saldoDisp.innerText = "$" + saldoFinal.toLocaleString('es-AR', {minimumFractionDigits: 2});
        saldoDisp.style.color = saldoFinal < 0 ? 'var(--negativo)' : (saldoFinal > 0 ? 'var(--positivo)' : 'var(--primary)');
        
        estadoTag.style.backgroundColor = saldoFinal < 0 ? 'var(--negativo)' : (saldoFinal > 0 ? 'var(--positivo)' : 'var(--neutro)');
        estadoTag.innerText = saldoFinal < 0 ? "SOBRE REPORTADO" : (saldoFinal > 0 ? "FALTA REPORTAR" : "CONSOLIDADO");

        // Conciliación J vs K
        let conciliadosJ = new Set(), conciliadosK = new Set();
        for (let i = 1; i < rows.length; i++) {
            let mK = limpiarMonto(rows[i].K) || 0;
            if (mK === 0) continue;
            let fE = excelDateToJS(rows[i].E);
            for (let j = 1; j < rows.length; j++) {
                if (conciliadosJ.has(j)) continue;
                if (mK === (limpiarMonto(rows[j].J) || 0) && Math.abs(fE - excelDateToJS(rows[j].E)) / 86400000 <= 10) {
                    conciliadosK.add(i); conciliadosJ.add(j); break;
                }
            }
        }

        const totalesFD = {};
        rows.forEach(fila => {
            if ((fila.I || "").toString().toUpperCase().includes("FIRST DATA CONO SUR S")) {
                const f = fila.E ? fila.E.toString() : "Sin Fecha";
                totalesFD[f] = (totalesFD[f] || 0) + (limpiarMonto(fila.J) || 0);
            }
        });

        const cols = ['E', 'F', 'G', 'H', 'I', 'J', 'K'];
        const header = document.getElementById('tableHeader');
        header.innerHTML = '';
        cols.forEach(c => { header.innerHTML += `<th>${rows[0][c] || c}</th>`; });
        header.innerHTML += '<th>Neto</th><th>Comisión MP</th><th>TOTAL FIRST DATA</th>';

        const body = document.getElementById('tableBody');
        body.innerHTML = '';

        for (let i = 1; i < rows.length; i++) {
            const fila = rows[i];
            if (!fila.E && !fila.I) continue;
            const tr = document.createElement('tr');
            const desc = (fila.I || "").toString().toUpperCase();
            const fecha = fila.E ? fila.E.toString() : "Sin Fecha";
            const esMP = (fila.H || "").toString().startsWith("***") && desc.startsWith("MERPAGO");
            const esComiMP = desc.includes("COMI MP");
            const esFD = desc.includes("FIRST DATA CONO SUR S");
            const esCB = desc.includes("CB");

            cols.forEach(c => {
                const td = document.createElement('td');
                td.innerText = fila[c] || '';
                let val = limpiarMonto(fila[c]) || 0;
                if (c === 'I') {
                    if (esComiMP) td.classList.add('celda-comi-mp');
                    else if (esMP) td.classList.add('celda-descripcion-mp');
                    else if (esFD) td.classList.add('celda-first-data');
                    else if (esCB) td.classList.add('celda-cb');
                } else if (c === 'J') {
                    if (esCB) td.classList.add('celda-cb');
                    else if (esFD) td.classList.add('celda-first-data');
                    else if (val !== 0) td.classList.add(conciliadosJ.has(i) ? 'celda-match' : 'celda-sin-match');
                } else if (c === 'K') {
                    if (esComiMP) td.classList.add('celda-comi-mp');
                    else if (esCB) td.classList.add('celda-cb');
                    else if (val !== 0) td.classList.add(conciliadosK.has(i) ? 'celda-match' : 'celda-sin-match');
                }
                tr.appendChild(td);
            });

            // Cálculos dinámicos MP
            let cNeto = "-", cCom = "-";
            if (esMP) {
                const valJ = Math.abs(limpiarMonto(fila.J) || 0);
                if (valJ > 0) {
                    cCom = (valJ / 6.099).toLocaleString('es-AR', {minimumFractionDigits: 2});
                    cNeto = (valJ - (valJ / 6.099)).toLocaleString('es-AR', {minimumFractionDigits: 2});
                }
            }

            // Agrupación First Data
            let cFD = "-"; let tFD = false;
            if (esFD) {
                let esUltima = true;
                for (let n = i + 1; n < rows.length; n++) {
                    if ((rows[n].I || "").toString().toUpperCase().includes("FIRST DATA CONO SUR S")) {
                        if ((rows[n].E ? rows[n].E.toString() : "Sin Fecha") === fecha) esUltima = false;
                        break;
                    }
                }
                if (esUltima) { cFD = totalesFD[fecha].toLocaleString('es-AR', {minimumFractionDigits: 2}); tFD = true; }
            }
            tr.innerHTML += `<td class="col-especial">${cNeto}</td><td class="col-especial">${cCom}</td><td class="col-fd-total ${tFD ? 'bg-total-fd' : ''}">${cFD}</td>`;
            body.appendChild(tr);
        }
        document.getElementById('downloadPdf').style.display = 'flex';
    }

    // PDF y Calculadora (Igual a versiones anteriores)
    document.getElementById('downloadPdf').addEventListener('click', function() {
        html2pdf().set({ margin: 5, filename: 'Reporte_LMS.pdf', html2canvas: { scale: 3 }, jsPDF: { orientation: 'landscape' } }).from(document.getElementById('reporte-area')).save();
    });

    function toggleCalc() { const c = document.getElementById('calc-container'); c.style.display = (c.style.display === 'none' || c.style.display === '') ? 'block' : 'none'; }
    document.getElementById('close-calc').onclick = toggleCalc;
    let d = document.getElementById('calc-display');
    function calcInput(v) { d.value += v; }
    function calcClear() { d.value = ''; }
    function calcBackspace() { d.value = d.value.slice(0, -1); }
    function calcResult() { try { let r = eval(d.value); d.value = Number.isInteger(r) ? r : r.toFixed(2); } catch(e) { d.value = "Error"; setTimeout(calcClear, 1000); } }

    dragElement(document.getElementById("calc-container"));
    function dragElement(elmnt) {
        var p1 = 0, p2 = 0, p3 = 0, p4 = 0;
        document.getElementById("calc-header").onmousedown = (e) => {
            e.preventDefault(); p3 = e.clientX; p4 = e.clientY;
            document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
            document.onmousemove = (e) => {
                p1 = p3 - e.clientX; p2 = p4 - e.clientY; p3 = e.clientX; p4 = e.clientY;
                elmnt.style.top = (elmnt.offsetTop - p2) + "px"; elmnt.style.left = (elmnt.offsetLeft - p1) + "px";
                elmnt.style.bottom = "auto";
            };
        };
    }
</script>
</body>
</html>


