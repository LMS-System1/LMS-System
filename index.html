<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMS System</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="runtime.data.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --mp-bg: #f0f9ff; --mp-color: #0ea5e9;
            --match-bg: #dcfce7; --match-text: #166534; --no-match: #ffedd5; --no-match-text: #9a3412;
            --cb-bg: #F5D0CE; --cb-texto: #721c24;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); }
        
        /* Login Overlay */
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 350px; }
        .login-box h2 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }
        .login-box input { display: block; width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); border: none; color: white; cursor: pointer; border-radius: 0.5rem; font-weight: 600; transition: 0.3s; }
        
        /* Main Container */
        .container { max-width: 1450px; margin: 2rem auto; padding: 0 1.5rem; display: none; }

        .welcome-header { 
            background: white; padding: 2rem; border-radius: 1rem; border: 1px solid var(--border);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .welcome-header i { color: var(--accent); font-size: 2.5rem; }
        .welcome-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--primary); }

        .upload-card { background: var(--white); padding: 1.5rem 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); gap: 10px; flex-wrap: wrap; }
        .btn-cargar { background: var(--accent); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; cursor: pointer; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .btn-cargar.secondary { background: var(--neutro); }
        
        #upload { display: none; }

        /* Summary & Tables */
        #reporte-area { display: none; animation: fadeIn 0.5s ease; }
        .summary-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .info-card { background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .saldo-val { display: block; font-size: 2rem; font-weight: 800; }
        .estado-tag { display: inline-flex; align-items: center; padding: 0.25rem 1rem; border-radius: 2rem; color: white; font-size: 0.85rem; font-weight: 700; }

        .table-container { background: white; border-radius: 1rem; border: 1px solid var(--border); overflow: auto; max-height: 70vh; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        th { background: #f1f5f9; color: var(--neutro); padding: 1rem; text-align: left; white-space: nowrap; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        td { padding: 0.85rem 1rem; border-bottom: 1px solid #f1f5f9; }
        
        /* INTERACCIÓN MANUAL (Prioridad !important) */
        .manual-verde { background-color: #22c55e !important; color: white !important; border-left: none !important; }
        .manual-naranja { background-color: #f59e0b !important; color: white !important; border-left: none !important; }
        .manual-rojo { background-color: #ef4444 !important; color: white !important; border-left: none !important; }

        .celda-interactiva { cursor: pointer; user-select: none; transition: background 0.2s; }
        .celda-interactiva:hover { filter: brightness(0.9); }

        /* Colores Condicionales (Solo si hay contenido) */
        .celda-match { background-color: var(--match-bg); color: var(--match-text); }
        .celda-sin-match { background-color: var(--no-match); color: var(--no-match-text); }
        .celda-desc-mp { background-color: var(--mp-bg); color: var(--mp-color); border-left: 4px solid var(--mp-color); }
        .celda-mp-valor { background-color: var(--mp-bg); color: var(--mp-color); }
        .celda-fd-valor { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .celda-cb { background-color: var(--cb-bg); color: var(--cb-texto); }

        /* Calculadora */
        #calc-container { position: fixed; bottom: 80px; right: 25px; width: 220px; background: #1e293b; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 10000; padding: 12px; cursor: move; display: none; border: 1px solid #334155; }
        #calc-display { width: 100%; border: none; background: #0f172a; color: #10b981; padding: 12px; text-align: right; font-family: monospace; font-size: 1.3rem; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-buttons button { padding: 10px 2px; border: none; border-radius: 6px; background: #334155; color: white; cursor: pointer; font-weight: 600; }
        #open-calc-btn { position: fixed; bottom: 20px; right: 25px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; border: none; cursor: pointer; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <i class="fas fa-user-shield fa-3x" style="color: var(--accent); margin-bottom: 1rem;"></i>
        <h2>Sistema LMS</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contraseña">
        <button id="btnLogin">Ingresar al Sistema</button>
    </div>
</div>

<div class="container" id="main-content">
    <div class="welcome-header">
        <i class="fas fa-user-circle"></i>
        <div>
            <h1>Bienvenido, <span id="user-display"></span></h1>
            <p>Sistema de Gestión Lector DBU-004 LMS</p>
        </div>
    </div>

    <div class="upload-card">
        <div class="brand">
            <button class="btn-cargar" onclick="abrirSelector(false)">
                <i class="fas fa-file-excel"></i> Lector DBU-004
            </button>
            <button class="btn-cargar secondary" onclick="abrirSelector(true)">
                <i class="fas fa-history"></i> Ult. vez en "0"
            </button>
            <input type="file" id="upload" accept=".xlsx, .xls" />
            <button id="btnResetTotal" class="btn-cargar" style="background: #64748b;">
                <i class="fas fa-trash-alt"></i> Limpiar mis marcas
            </button>
        </div>
        
        <button id="downloadPdf" class="btn-cargar" style="background: #dc2626; display: none;">
            <i class="fas fa-file-pdf"></i> Exportar a PDF
        </button>
    </div>

    <div id="reporte-area">
        <div class="summary-grid">
            <div class="info-card">
                <div>
                    <h4>Unidad: <span id="unidadNombre" style="color:var(--accent)">-</span></h4>
                    <h4>Líder de Cuenta: <span id="liderNombre" style="color:var(--accent)">-</span></h4>
                </div>
            </div>
            <div class="info-card" style="border-top: 4px solid var(--accent);">
                <div style="width: 100%;">
                    <h4>Balance Final</h4>
                    <span id="saldoFinal" class="saldo-val">$0,00</span>
                    <div id="estadoTexto" class="estado-tag">Cargando...</div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="calc-container">
    <div id="calc-header" style="color:white; display:flex; justify-content:space-between; padding:12px; cursor:move; font-size: 0.75rem; font-weight: 700;">
        <span><i class="fas fa-calculator"></i> CALCULADORA</span>
        <span id="close-calc" style="cursor:pointer; font-size: 1.2rem;">×</span>
    </div>
    <input type="text" id="calc-display" readonly placeholder="0">
    <div class="calc-buttons" style="padding: 0 12px 12px 12px;">
        <button onclick="calcClear()" style="color: #ef4444;">C</button>
        <button onclick="calcInput('/')">/</button>
        <button onclick="calcInput('*')">*</button>
        <button onclick="calcBackspace()"><i class="fas fa-backspace"></i></button>
        <button onclick="calcInput('7')">7</button>
        <button onclick="calcInput('8')">8</button>
        <button onclick="calcInput('9')">9</button>
        <button onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button>
        <button onclick="calcInput('5')">5</button>
        <button onclick="calcInput('6')">6</button>
        <button onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button>
        <button onclick="calcInput('2')">2</button>
        <button onclick="calcInput('3')">3</button>
        <button onclick="calcResult()" style="background:var(--positivo)">=</button>
        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button>
        <button onclick="calcInput('.')">.</button>
    </div>
</div>
<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<script>
    let modoBusquedaCero = false;

    // Formateo de Dinero
    function formatMoney(val) {
        if (val === null || val === undefined || isNaN(val)) return "-";
        return val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Rotación de colores manual
    function rotarColor(e) {
        const td = e.currentTarget;
        const estados = ['', 'manual-verde', 'manual-naranja', 'manual-rojo'];
        let actualIdx = 0;
        estados.forEach((cls, idx) => { if(cls !== '' && td.classList.contains(cls)) actualIdx = idx; });
        estados.forEach(cls => { if(cls !== '') td.classList.remove(cls); });
        let next = (actualIdx + 1) % estados.length;
        if(estados[next] !== '') td.classList.add(estados[next]);
    }

    // Login (Basado en DB_USUARIOS de runtime.data.js)
    async function generarHash(s) {
        const b = new TextEncoder().encode(s);
        const h = await crypto.subtle.digest('SHA-256', b);
        return Array.from(new Uint8Array(h)).map(x => x.toString(16).padStart(2, '0')).join('');
    }

    async function validarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const h = await generarHash(p);
        if (typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === h) {
            document.getElementById('user-display').innerText = u;
            document.getElementById('login-overlay').remove();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else alert("Credenciales incorrectas.");
    }
    document.getElementById('btnLogin').onclick = validarLogin;

    function abrirSelector(b) { modoBusquedaCero = b; document.getElementById('upload').click(); }
    
    function limpiarMonto(v) { 
        if (!v && v !== 0) return null; if (typeof v === 'number') return v; 
        let s = v.toString().trim(); 
        if (s.includes(',') && s.includes('.')) s = s.replace(/\./g, '').replace(',', '.'); 
        else if (s.includes(',')) s = s.replace(',', '.'); 
        let n = parseFloat(s.replace(/[^0-9.-]/g, '')); return isNaN(n) ? null : n; 
    }

    document.getElementById('upload').onchange = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const d = new Uint8Array(ev.target.result);
            const w = XLSX.read(d, {type: 'array', cellDates: true});
            const rows = XLSX.utils.sheet_to_json(w.Sheets[w.SheetNames[0]], {header: "A", defval: ""});
            if(rows.length > 0) modoBusquedaCero ? procesarUltimoCero(rows) : generarReporte(rows);
            e.target.value = '';
        };
        r.readAsArrayBuffer(f);
    };

    function procesarUltimoCero(rows) {
        for (let i = rows.length - 1; i >= 1; i--) {
            if (limpiarMonto(rows[i].L) === 0 && rows[i].L !== "") {
                alert(`Último $0 encontrado: ${rows[i].C} - ${rows[i].E}`);
                return;
            }
        }
        alert("No se encontró balance en 0.");
    }

    function generarReporte(rows) {
        document.getElementById('reporte-area').style.display = 'block';
        document.getElementById('unidadNombre').innerText = rows[1]?.B || "N/A";
        
        let lid = "No identificado";
        for(let r of rows) if(r.C?.toString().includes("HSBC")) { lid = r.D; break; }
        document.getElementById('liderNombre').innerText = lid;

        const sld = limpiarMonto(rows[rows.length-1]?.L) || 0;
        document.getElementById('saldoFinal').innerText = "$" + formatMoney(sld);
        const tag = document.getElementById('estadoTexto');
        tag.style.background = sld < 0 ? 'var(--negativo)' : (sld > 0 ? 'var(--positivo)' : 'var(--neutro)');
        tag.innerText = sld < 0 ? "SOBRE REPORTADO" : (sld > 0 ? "FALTA REPORTAR" : "CONSOLIDADO");

        // Pre-calculos de matching e importes
        let cJ = new Set(), cK = new Set();
        for(let i=1; i<rows.length; i++) {
            let mk = limpiarMonto(rows[i].K); if(!mk) continue;
            for(let j=1; j<rows.length; j++){
                if(!cJ.has(j) && mk === limpiarMonto(rows[j].J)) {
                    cK.add(i); cJ.add(j); break;
                }
            }
        }

        const tFD = {};
        rows.forEach(f => {
            if(f.I?.toString().includes("FIRST DATA")) {
                let e = f.E?.toString() || "SF";
                tFD[e] = (tFD[e]||0) + (limpiarMonto(f.J)||0);
            }
        });

        const body = document.getElementById('tableBody');
        const head = document.getElementById('tableHeader');
        head.innerHTML = '<th>Fecha</th><th>Tarjeta</th><th>Descripción</th><th>Cantidad Tarjeta</th><th>Cantidad Declarada</th><th>Monto Neto</th><th>Comision MP</th><th>TOTAL FD</th>';
        body.innerHTML = '';

        for(let i=1; i<rows.length; i++){
            const f = rows[i]; if(!f.E && !f.I) continue;
            const tr = document.createElement('tr');
            const d = (f.I || "").toString().toUpperCase();
            const esMP = d.includes("MERPAGO");
            const esFD = d.includes("FIRST DATA");

            // Columnas del Excel (E a K)
            ['E','F','I','J','K'].forEach(c => {
                const td = document.createElement('td');
                let m = limpiarMonto(f[c]);
                td.innerText = (c==='J'||c==='K') ? formatMoney(m) : (f[c]||'');
                td.classList.add('celda-interactiva');
                td.onclick = rotarColor;

                if(c==='J' || c==='K') {
                    if(m !== null && m !== 0) {
                        if(esFD && c==='J') td.classList.add('celda-fd-valor');
                        else td.classList.add( (c==='J' ? cJ.has(i) : cK.has(i)) ? 'celda-match' : 'celda-sin-match' );
                    }
                }
                if(c==='I') {
                    if(esMP) td.classList.add('celda-desc-mp');
                    if(esFD) td.classList.add('celda-fd-valor');
                    if(d.includes("CB")) td.classList.add('celda-cb');
                }
                tr.appendChild(td);
            });

            // Columnas Extras (Calculadas)
            let netoVal = "-", comiVal = "-", fdVal = "-";
            if(esMP) {
                let v = Math.abs(limpiarMonto(f.J)||0);
                if(v > 0) {
                    netoVal = formatMoney(v/1.0699);
                    comiVal = formatMoney(v - (v/1.0699));
                }
            }
            if(esFD) {
                let e = f.E?.toString() || "SF";
                if (e !== (rows[i + 1]?.E?.toString() || null)) fdVal = formatMoney(tFD[e]);
            }

            [netoVal, comiVal, fdVal].forEach((val, idx) => {
                const td = document.createElement('td');
                td.innerText = val;
                td.classList.add('celda-interactiva');
                td.onclick = rotarColor;
                // SOLO COLOR SI HAY VALOR
                if(val !== "-") {
                    if(idx < 2) td.classList.add('celda-mp-valor');
                    else td.classList.add('celda-fd-valor');
                }
                tr.appendChild(td);
            });
            body.appendChild(tr);
        }
        document.getElementById('downloadPdf').style.display = 'flex';
    }

    // Funciones Calculadora
    function toggleCalc() { const c = document.getElementById('calc-container'); c.style.display = (c.style.display==='none'?'block':'none'); }
    function calcInput(v) { document.getElementById('calc-display').value += v; }
    function calcClear() { document.getElementById('calc-display').value = ''; }
    function calcBackspace() { let d = document.getElementById('calc-display'); d.value = d.value.slice(0,-1); }
    function calcResult() { try { document.getElementById('calc-display').value = eval(document.getElementById('calc-display').value).toFixed(2); } catch(e) { } }
    document.getElementById('close-calc').onclick = toggleCalc;

    // Arrastre de calculadora
    const cl = document.getElementById("calc-container"), h = document.getElementById("calc-header");
    let px=0, py=0, cx=0, cy=0;
    h.onmousedown = (e) => {
        cx=e.clientX; cy=e.clientY;
        document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
        document.onmousemove = (e) => {
            px=cx-e.clientX; py=cy-e.clientY; cx=e.clientX; cy=e.clientY;
            cl.style.top = (cl.offsetTop - py) + "px"; cl.style.left = (cl.offsetLeft - px) + "px";
        };
    };

    document.getElementById('btnResetTotal').onclick = () => {
        document.querySelectorAll('.manual-verde, .manual-naranja, .manual-rojo').forEach(el => el.classList.remove('manual-verde', 'manual-naranja', 'manual-rojo'));
    };

    document.getElementById('downloadPdf').onclick = () => {
        html2pdf().set({ margin: 5, filename: 'Reporte_LMS.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' } }).from(document.getElementById('reporte-area')).save();
    };
</script>
</body>
</html>
