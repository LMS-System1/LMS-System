<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LECTOR DBU-004 - LMS</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="runtime.data.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --bg: #f8fafc; --white: #ffffff; 
            --negativo: #ef4444; --positivo: #10b981; --neutro: #64748b; --border: #e2e8f0;
            --bordo-claro: #F2E7F4; --bordo-texto: #4A148C; --cb-bg: #F5D0CE; --cb-texto: #721c24;
            --mp-color: #0ea5e9; --mp-bg: #f0f9ff; --match-bg: #dcfce7; --match-text: #166534;
            --no-match: #ffedd5; --no-match-text: #9a3412; --comi-mp: #fef9c3; --comi-mp-text: #854d0e;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--bg); color: var(--primary); }
        
        #login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 2rem; border-radius: 1rem; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); width: 350px; }
        .login-box h2 { margin-bottom: 1.5rem; font-weight: 700; color: var(--primary); }
        .login-box input { display: block; width: 100%; padding: 0.75rem; margin: 0.75rem 0; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 0.75rem; background: var(--accent); border: none; color: white; cursor: pointer; border-radius: 0.5rem; font-weight: 600; transition: 0.3s; }
        
        .container { max-width: 1450px; margin: 2rem auto; padding: 0 1.5rem; display: none; }

        .welcome-header { 
            background: white; padding: 2rem; border-radius: 1rem; border: 1px solid var(--border);
            margin-bottom: 1.5rem; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .welcome-header i { color: var(--accent); font-size: 2.5rem; }
        .welcome-header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .welcome-header p { margin: 5px 0 0 0; color: var(--neutro); font-size: 0.95rem; }

        .upload-card { background: var(--white); padding: 1.5rem 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .brand { display: flex; gap: 12px; align-items: center; }
        .btn-cargar { background: var(--accent); color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; cursor: pointer; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 12px; transition: all 0.3s ease; }
        .btn-cargar.secondary { background: var(--neutro); }
        #upload { display: none; }

        /* TOGGLE BUTTON STYLE */
        .toggle-container { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 8px 15px; border-radius: 50px; border: 1px solid var(--border); cursor: pointer; transition: 0.3s; user-select: none; }
        .toggle-container.off { opacity: 0.6; }
        .toggle-switch { width: 40px; height: 20px; background: #cbd5e1; border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-container.on .toggle-switch { background: var(--positivo); }
        .toggle-container.on .toggle-switch::after { left: 22px; }

        .table-container { 
            background: white; border-radius: 1rem; border: 1px solid var(--border); 
            overflow: auto; max-height: 70vh; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        th { 
            background: #f1f5f9; color: var(--neutro); padding: 1rem; text-align: left; 
            white-space: nowrap; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border);
        }
        td { padding: 0.85rem 1rem; border-bottom: 1px solid #f1f5f9; }

        /* INTERACTIVIDAD Y COLORES MANUALES */
        .celda-interactiva { cursor: pointer; user-select: none; transition: 0.1s; }
        .celda-interactiva:hover { outline: 2px solid var(--accent); outline-offset: -2px; }

        .manual-verde { background-color: var(--match-bg) !important; color: var(--match-text) !important; font-weight: 600; }
        .manual-naranja { background-color: var(--no-match) !important; color: var(--no-match-text) !important; font-weight: 600; }
        .manual-rojo { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: 600; }

        /* CLASES OCULTABLES (Para el modo Toggle OFF) */
        .hide-manual .manual-verde, .hide-manual .manual-naranja, .hide-manual .manual-rojo { 
            background-color: transparent !important; color: inherit !important; 
        }

        /* CLASES ORIGINALES */
        .celda-match { background-color: var(--match-bg); color: var(--match-text); }
        .celda-sin-match { background-color: var(--no-match); color: var(--no-match-text); }
        .celda-comi-mp { background-color: var(--comi-mp); color: var(--comi-mp-text); }
        .celda-descripcion-mp { background-color: var(--mp-bg); color: var(--mp-color); border-left: 4px solid var(--mp-color); }
        .col-especial { background-color: #f8fafc; font-weight: 700; color: var(--mp-color); border-left: 1px solid var(--border); text-align: right; }
        .col-fd-total { font-weight: 800; text-align: right; border-left: 1px solid var(--border); color: var(--neutro); }
        .bg-total-fd { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .celda-first-data { background-color: var(--bordo-claro); color: var(--bordo-texto); }
        .celda-cb { background-color: var(--cb-bg); color: var(--cb-texto); }

        /* CALCULADORA */
        #calc-container { position: fixed; bottom: 80px; right: 25px; width: 220px; background: #1e293b; border-radius: 10px; z-index: 10000; padding: 12px; cursor: move; display: none; border: 1px solid #334155; }
        #calc-header { color: white; font-size: 0.75rem; font-weight: 700; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        #calc-display { width: 100%; border: none; background: #0f172a; color: #10b981; padding: 12px; text-align: right; font-family: monospace; font-size: 1.3rem; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-buttons button { padding: 10px 2px; border: none; border-radius: 6px; background: #334155; color: white; cursor: pointer; }
        #open-calc-btn { position: fixed; bottom: 20px; right: 25px; width: 50px; height: 50px; border-radius: 50%; background: var(--accent); color: white; border: none; cursor: pointer; z-index: 9999; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <i class="fas fa-user-shield fa-3x" style="color: var(--accent); margin-bottom: 1rem;"></i>
        <h2>Sistema LMS</h2>
        <input type="text" id="user" placeholder="Usuario">
        <input type="password" id="pass" placeholder="Contraseña">
        <button id="btnLogin">Ingresar al Sistema</button>
    </div>
</div>

<div class="container" id="main-content">
    <div class="welcome-header">
        <i class="fas fa-user-circle"></i>
        <div>
            <h1>Bienvenido, <span id="user-display"></span></h1>
            <p>Sistema de Gestión Lector DBU-004 LMS</p>
        </div>
    </div>

    <div class="upload-card">
        <div class="brand">
            <button class="btn-cargar" onclick="abrirSelector(false)">
                <i class="fas fa-credit-card"></i> Lector DBU-004
            </button>
            <button class="btn-cargar secondary" onclick="abrirSelector(true)">
                <i class="fas fa-history"></i> Ult. vez en "0"
            </button>
            <input type="file" id="upload" accept=".xlsx, .xls" />
        </div>

        <div style="display: flex; gap: 15px; align-items: center;">
            <div id="toggleManual" class="toggle-container on" onclick="toggleColoresManuales()">
                <div class="toggle-switch"></div>
                <span style="font-size: 0.8rem; font-weight: 600; color: var(--primary);">MIS MARCAS</span>
            </div>
            
            <button id="downloadPdf" style="background: #dc2626; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px;">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </div>

    <div id="reporte-area">
        <div class="summary-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
            <div class="info-card" style="background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border);">
                <div style="display: flex; gap: 3rem;">
                    <div><h4 style="margin:0; color:var(--neutro); font-size:0.8rem;">Unidad</h4><p id="unidadNombre" style="margin:5px 0 0 0; font-weight:700;">-</p></div>
                    <div><h4 style="margin:0; color:var(--neutro); font-size:0.8rem;">Líder de Cuenta</h4><p id="liderNombre" style="margin:5px 0 0 0; font-weight:700;">-</p></div>
                </div>
            </div>
            <div class="info-card" style="background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid var(--border); border-top: 4px solid var(--accent);">
                <h4 style="margin:0; color:var(--neutro); font-size:0.8rem;">Balance Final</h4>
                <span id="saldoFinal" style="font-size: 1.8rem; font-weight: 800; display: block;">$0,00</span>
                <div id="estadoTexto" class="estado-tag" style="padding: 2px 10px; border-radius: 10px; color: white; display: inline-block; font-size: 0.7rem; font-weight: 700;">-</div>
            </div>
        </div>
        
        <div class="table-container" id="reporteTableContainer">
            <table id="mainTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="historial-area" style="display:none; margin-top:20px;">
        <div style="background:var(--neutro); color:white; padding:10px; border-radius:10px 10px 0 0; font-weight:700;">Último Cero Encontrado</div>
        <table style="width:100%; background:white; border:1px solid var(--border);">
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<div id="calc-container">
    <div id="calc-header"><span>CALCULADORA</span><span id="close-calc" style="cursor:pointer">×</span></div>
    <input type="text" id="calc-display" readonly>
    <div class="calc-buttons">
        <button onclick="calcClear()">C</button>
        <button onclick="calcInput('/')">/</button><button onclick="calcInput('*')">*</button><button onclick="calcBackspace()"><i class="fas fa-backspace"></i></button>
        <button onclick="calcInput('7')">7</button><button onclick="calcInput('8')">8</button><button onclick="calcInput('9')">9</button><button onclick="calcInput('-')">-</button>
        <button onclick="calcInput('4')">4</button><button onclick="calcInput('5')">5</button><button onclick="calcInput('6')">6</button><button onclick="calcInput('+')">+</button>
        <button onclick="calcInput('1')">1</button><button onclick="calcInput('2')">2</button><button onclick="calcInput('3')">3</button><button onclick="calcResult()" style="background:var(--positivo); grid-row: span 2;">=</button>
        <button onclick="calcInput('0')" style="grid-column: span 2;">0</button><button onclick="calcInput('.')">.</button>
    </div>
</div>
<button id="open-calc-btn" onclick="toggleCalc()"><i class="fas fa-calculator"></i></button>

<script>
    let modoBusquedaCero = false;
    let marcasActivas = true;

    function formatMoney(val) {
        if (val === null || val === undefined || isNaN(val)) return "-";
        return val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // --- LÓGICA DE ROTACIÓN DE COLORES ---
    function rotarColor(e) {
        const td = e.currentTarget;
        const estados = ['', 'manual-verde', 'manual-naranja', 'manual-rojo'];
        const clasesAuto = ['celda-match', 'celda-sin-match', 'celda-comi-mp', 'celda-descripcion-mp', 'celda-first-data', 'celda-cb', 'bg-total-fd'];

        let actualIdx = 0;
        estados.forEach((cls, i) => { if (cls !== '' && td.classList.contains(cls)) actualIdx = i; });

        // Limpiar todo para aplicar el nuevo
        estados.forEach(cls => { if(cls !== '') td.classList.remove(cls); });
        clasesAuto.forEach(cls => td.classList.remove(cls));

        let siguienteIdx = (actualIdx + 1) % estados.length;
        if (estados[siguienteIdx] !== '') {
            td.classList.add(estados[siguienteIdx]);
        } else {
            // Si vuelve a "vacío", queda blanco total (reseteo)
            td.style.backgroundColor = "transparent";
        }
    }

    function toggleColoresManuales() {
        const btn = document.getElementById('toggleManual');
        const container = document.getElementById('reporteTableContainer');
        marcasActivas = !marcasActivas;
        
        if (marcasActivas) {
            btn.classList.add('on');
            btn.classList.remove('off');
            container.classList.remove('hide-manual');
        } else {
            btn.classList.add('off');
            btn.classList.remove('on');
            container.classList.add('hide-manual');
        }
    }

    async function validarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const msgUint8 = new TextEncoder().encode(p);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
        const hashP = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        
        if (typeof DB_USUARIOS !== 'undefined' && DB_USUARIOS[u] === hashP) {
            document.getElementById('user-display').innerText = u;
            document.getElementById('login-overlay').remove();
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('open-calc-btn').style.display = 'flex';
        } else { alert("Credenciales incorrectas."); }
    }

    document.getElementById('btnLogin').onclick = validarLogin;
    document.getElementById('pass').onkeypress = (e) => { if(e.key === 'Enter') validarLogin(); };

    function abrirSelector(esCero) { modoBusquedaCero = esCero; document.getElementById('upload').click(); }
    
    function limpiarMonto(v) { 
        if (!v) return null; if (typeof v === 'number') return v; 
        let s = v.toString().replace(/\./g, '').replace(',', '.');
        let n = parseFloat(s.replace(/[^0-9.-]/g, ''));
        return isNaN(n) ? null : n; 
    }

    document.getElementById('upload').addEventListener('change', function(e) {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, {type: 'array', cellDates: true});
            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: "A", defval: ""});
            if (modoBusquedaCero) procesarCero(rows); else generarReporte(rows);
            e.target.value = '';
        };
        reader.readAsArrayBuffer(file);
    });

    function procesarCero(rows) {
        let encontrado = false;
        for (let i = rows.length - 1; i >= 1; i--) {
            if (limpiarMonto(rows[i].L) === 0) {
                document.getElementById('historialBody').innerHTML = `<tr><td>${rows[i].C}</td><td>${rows[i].D}</td><td>${rows[i].B}</td><td>${rows[i].E}</td></tr>`;
                document.getElementById('historial-area').style.display = 'block';
                encontrado = true; break;
            }
        }
        if(!encontrado) alert("No se halló balance 0");
    }

    function generarReporte(rows) {
        document.getElementById('reporte-area').style.display = 'block';
        document.getElementById('unidadNombre').innerText = rows[1]?.B || "-";
        
        let lider = "No hallado";
        for(let r of rows) { if(r.C?.toString().includes("HSBC")) { lider = r.D; break; } }
        document.getElementById('liderNombre').innerText = lider;

        const saldo = limpiarMonto(rows[rows.length-1]?.L) || 0;
        document.getElementById('saldoFinal').innerText = formatMoney(saldo);
        const st = document.getElementById('estadoTexto');
        st.innerText = saldo < 0 ? "SOBRE REPORTADO" : (saldo > 0 ? "FALTA REPORTAR" : "CONSOLIDADO");
        st.style.background = saldo < 0 ? 'var(--negativo)' : (saldo > 0 ? 'var(--positivo)' : 'var(--neutro)');

        const tHeader = document.getElementById('tableHeader');
        const tBody = document.getElementById('tableBody');
        tHeader.innerHTML = ''; tBody.innerHTML = '';

        const cols = ['E','F','G','H','I','J','K'];
        cols.forEach(c => { let th = document.createElement('th'); th.innerText = rows[0][c] || c; tHeader.appendChild(th); });
        ['Neto','Comisión','Total FD'].forEach(h => { let th = document.createElement('th'); th.innerText = h; tHeader.appendChild(th); });

        // Totales First Data
        const fds = {};
        rows.forEach(r => { if(r.I?.toString().includes("FIRST DATA")) { let f = r.E?.toString(); fds[f] = (fds[f]||0) + (limpiarMonto(r.J)||0); } });

        for(let i=1; i<rows.length; i++) {
            const r = rows[i]; if(!r.E && !r.I) continue;
            const tr = document.createElement('tr');
            const desc = r.I?.toString().toUpperCase() || "";
            const esMP = r.H?.toString().startsWith("***") && desc.includes("MERPAGO");
            const esFD = desc.includes("FIRST DATA");

            cols.forEach(c => {
                const td = document.createElement('td');
                const val = r[c]; const m = limpiarMonto(val);
                td.innerText = (c==='J' || c==='K') ? formatMoney(m) : (val||'');
                
                // Clases automáticas
                if(c==='I' && esMP) td.className = 'celda-descripcion-mp';
                if(c==='I' && esFD) td.className = 'celda-first-data';
                if((c==='J' || c==='K') && m !== null) {
                    td.classList.add('celda-interactiva');
                    td.onclick = rotarColor;
                }
                tr.appendChild(td);
            });

            // Columnas de cálculo
            let neto="-", com="-", tfd="-";
            if(esMP) { let j = Math.abs(limpiarMonto(r.J)||0); com = formatMoney(j/6.099); neto = formatMoney(j-(j/6.099)); }
            
            const tdN = document.createElement('td'); tdN.innerText = neto; tdN.className="col-especial celda-interactiva"; tdN.onclick = rotarColor; tr.appendChild(tdN);
            const tdC = document.createElement('td'); tdC.innerText = com; tdC.className="col-especial celda-interactiva"; tdC.onclick = rotarColor; tr.appendChild(tdC);
            
            if(esFD) {
                let sig = rows[i+1];
                if(!sig || sig.E?.toString() !== r.E?.toString() || !sig.I?.toString().includes("FIRST DATA")) {
                    tfd = formatMoney(fds[r.E?.toString()]);
                }
            }
            const tdF = document.createElement('td'); tdF.innerText = tfd; tdF.className="col-fd-total celda-interactiva"; if(tfd!=="-") tdF.classList.add('bg-total-fd'); tdF.onclick = rotarColor; tr.appendChild(tdF);

            tBody.appendChild(tr);
        }
        document.getElementById('downloadPdf').style.display = 'flex';
    }

    // PDF Y CALC
    document.getElementById('downloadPdf').onclick = () => {
        html2pdf().set({ margin: 5, filename: 'Reporte.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' } }).from(document.getElementById('reporte-area')).save();
    };

    function toggleCalc() { let c = document.getElementById('calc-container'); c.style.display = c.style.display === 'block' ? 'none' : 'block'; }
    document.getElementById('close-calc').onclick = toggleCalc;
    let d = document.getElementById('calc-display');
    function calcInput(v) { d.value += v; }
    function calcClear() { d.value = ''; }
    function calcBackspace() { d.value = d.value.slice(0,-1); }
    function calcResult() { try { d.value = eval(d.value).toFixed(2); } catch { d.value = "Error"; } }

    // Drag Calc
    const calc = document.getElementById("calc-container");
    const head = document.getElementById("calc-header");
    let px=0, py=0, x=0, y=0;
    head.onmousedown = (e) => {
        e.preventDefault(); x=e.clientX; y=e.clientY;
        document.onmousemove = (e) => {
            e.preventDefault(); px=x-e.clientX; py=y-e.clientY; x=e.clientX; y=e.clientY;
            calc.style.top = (calc.offsetTop - py) + "px"; calc.style.left = (calc.offsetLeft - px) + "px";
        };
        document.onmouseup = () => { document.onmousemove = null; };
    };
</script>
</body>
</html>
